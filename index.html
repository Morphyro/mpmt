<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Morphyro">
    <meta name="organization" content="S(i)S">
    <title>S(i)S - Mapa Mental</title>
    <style>
        :root {
            /* Tema Padr√£o */
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
            --connection-color: #8ea2fc;
        }

        /* Tema Azul Claro */
        .theme-blue {
            --primary-color: #4A90E2;
            --secondary-color: #7BB3F0;
            --background-gradient: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            --sidebar-bg: rgba(255, 255, 255, 0.9);
            --text-color: #1976D2;
            --connection-color: #4A90E2;
        }

        /* Tema Verde Institucional */
        .theme-green {
            --primary-color: #2E7D32;
            --secondary-color: #4CAF50;
            --background-gradient: linear-gradient(135deg, #E8F5E8 0%, #C8E6C9 100%);
            --sidebar-bg: rgba(255, 255, 255, 0.9);
            --text-color: #1B5E20;
            --connection-color: #2E7D32;
        }

        /* Tema Branco */
        .theme-white {
            --primary-color: #424242;
            --secondary-color: #616161;
            --background-gradient: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --text-color: #212121;
            --connection-color: #424242;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-gradient);
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 100vh;
            transition: background 0.3s ease;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: color 0.3s ease;
        }

        .logo::before {
            content: 'üß†';
            font-size: 28px;
        }

        .toolbar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        /* Efeito especial para o bot√£o Limpar quando o mapa de exemplo estiver presente */
        .btn-secondary.example-present {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            animation: examplePresentPulse 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary.example-present:hover {
            background: linear-gradient(135deg, #ff5252, #e53935);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        @keyframes examplePresentPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(255, 107, 107, 0.5);
            }
        }

        /* Efeito para mobile */
        .mobile-btn.secondary.example-present {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            animation: examplePresentPulse 2s ease-in-out infinite;
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }

        .mobile-btn.secondary.example-present:hover {
            background: linear-gradient(135deg, #ff5252, #e53935);
            transform: scale(1.05);
            box-shadow: 0 3px 15px rgba(255, 107, 107, 0.4);
        }

        /* Dica amig√°vel */
        .friendly-tip {
            position: absolute;
            top: 450px;
            left: 780px;
            transform: translate(-50%, -50%);
            z-index: 1000;
            animation: friendlyTipAppear 0.5s ease-out;
        }

        .friendly-tip-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
            text-align: center;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .friendly-tip-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: friendlyTipIconBounce 2s ease-in-out infinite;
        }

        .friendly-tip h3 {
            margin: 0 0 15px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .friendly-tip p {
            margin: 0 0 25px 0;
            font-size: 16px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .friendly-tip p strong {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .friendly-tip-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friendly-tip-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
        }

        @keyframes friendlyTipAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes friendlyTipIconBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Responsivo para mobile */
        @media (max-width: 768px) {
            .friendly-tip-content {
                margin: 20px;
                padding: 25px;
                max-width: calc(100vw - 40px);
            }

            .friendly-tip h3 {
                font-size: 20px;
            }

            .friendly-tip p {
                font-size: 14px;
            }

            .friendly-tip-icon {
                font-size: 40px;
            }
        }

        /* Confirma√ß√£o de limpeza */
        .clear-confirm {
            position: absolute;
            top: 450px;
            left: 780px;
            transform: translate(-50%, -50%);
            z-index: 1000;
            animation: clearConfirmAppear 0.5s ease-out;
        }

        .clear-confirm-content {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.4);
            text-align: center;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .clear-confirm-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: clearConfirmIconShake 0.5s ease-in-out;
        }

        .clear-confirm h3 {
            margin: 0 0 15px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .clear-confirm p {
            margin: 0 0 25px 0;
            font-size: 16px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .clear-confirm p strong {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .clear-confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .clear-confirm-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .clear-confirm-cancel:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .clear-confirm-ok {
            background: rgba(255, 255, 255, 0.9);
            color: #ff6b6b;
            border: 2px solid rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .clear-confirm-ok:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
        }

        @keyframes clearConfirmAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes clearConfirmIconShake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }

        /* Responsivo para mobile - confirma√ß√£o */
        @media (max-width: 768px) {
            .clear-confirm-content {
                margin: 20px;
                padding: 25px;
                max-width: calc(100vw - 40px);
            }

            .clear-confirm h3 {
                font-size: 20px;
            }

            .clear-confirm p {
                font-size: 14px;
            }

            .clear-confirm-icon {
                font-size: 40px;
            }

            .clear-confirm-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover, .color-option.active {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .custom-color-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(131, 139, 172, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .custom-color-picker {
            width: 100%;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(135deg, #48548b 0%, #764ba2 50%, #f093fb 100%);
            transition: all 0.3s ease;
        }

        .custom-color-picker:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .custom-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 8px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .custom-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .recent-colors-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .recent-colors-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .recent-color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .recent-color-option:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .recent-color-option.empty {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }

        .recent-color-option.empty:hover {
            border-color: #999;
            transform: none;
        }

        .shape-palette {
            display: flex;
            gap: 18px;
            margin-top: 15px;
        }

        .shape-option {
            width: 40px;
            height: 40px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .shape-option:hover, .shape-option.active {
            border-color: #667eea;
            transform: scale(1.1);
            background: rgba(102, 126, 234, 0.1);
        }

        .shape-preview {
            width: 24px;
            height: 24px;
            background: #667eea;
            transition: all 0.2s ease;
        }

        .rectangle-preview {
            border-radius: 4px;
            width: 28px;
            height: 18px;
        }

        .square-preview {
            border-radius: 4px;
            width: 20px;
            height: 20px;
        }

        .circle-preview {
            border-radius: 50%;
            width: 20px;
            height: 20px;
        }

        .ellipse-preview {
            border-radius: 50%;
            width: 24px;
            height: 16px;
        }


        .node-shape-rectangle {
            border-radius: 8px;
            min-width: 120px;
            min-height: 60px;
            padding: 15px 20px;
        }

        .node-shape-square {
            border-radius: 8px;
            width: 80px;
            height: 80px;
            min-width: 60px;
            min-height: 60px;
            max-width: 200px;
            max-height: 200px;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .node-shape-circle {
            border-radius: 50% !important;
            width: 80px;
            height: 80px;
            min-width: 60px;
            min-height: 60px;
            max-width: 200px;
            max-height: 200px;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .node-shape-ellipse {
            border-radius: 50%;
            width: 100px;
            height: 60px;
            min-width: 80px;
            min-height: 50px;
            max-width: 300px;
            max-height: 200px;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            position: relative;
        }

        .node-shape-ellipse .node-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            padding: 8px;
            box-sizing: border-box;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: 12px;
            line-height: 1.2;
            color: #000000;
        }

        .node-shape-square .node-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            padding: 8px;
            box-sizing: border-box;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: 12px;
            line-height: 1.2;
            color: #000000;
        }

        .node-shape-circle .node-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            padding: 8px;
            box-sizing: border-box;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: 12px;
            line-height: 1.2;
            color: #000000;
        }

        .node-shape-ellipse .node-controls {
            position: absolute;
            top: -15px;
            right: -15px;
            display: none;
            gap: 5px;
            z-index: 1001;
        }

        .node-shape-circle .node-controls {
            position: absolute;
            top: -15px;
            right: -15px;
            display: none;
            gap: 5px;
            z-index: 1001;
        }


        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .canvas {
            width: 100%;
            height: 100%;
            margin-left: -35%;
            margin-top: -40%;
            position: relative;
            cursor: grab;
            background:
                radial-gradient(circle at 20px 20px, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            transform-origin: 0 0;
            transition: transform 0.2s ease;
            min-width: 2000px;
            min-height: 2000px;
        }

        .canvas:active {
            cursor: grabbing;
        }
        
        .canvas.panning {
            cursor: grabbing;
        }

        .node {
            position: absolute;
            padding: 15px 20px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            cursor: move;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
            font-weight: 500;
            text-align: center;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            color: #000000;
        }

        .node.node-shape-square {
            padding: 0 !important;
            border-radius: 8px !important;
            width: 80px;
            height: 80px;
            min-width: 60px;
            min-height: 60px;
            max-width: 200px;
            max-height: 200px;
        }

        .node.node-shape-ellipse {
            padding: 0 !important;
            border-radius: 50% !important;
            width: 100px;
            height: 60px;
            min-width: 80px;
            min-height: 50px;
            max-width: 300px;
            max-height: 200px;
        }

        .node.node-shape-circle {
            padding: 0 !important;
            border-radius: 50% !important;
            width: 80px;
            height: 80px;
            min-width: 60px;
            min-height: 60px;
            max-width: 200px;
            max-height: 200px;
        }

        .node:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .node.node-shape-square:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-radius: 8px !important;
        }

        .node.node-shape-ellipse:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-radius: 50% !important;
        }

        .node.node-shape-circle:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-radius: 50% !important;
        }

        .node.selected {
            border-color: #667eea;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }

        .node.node-shape-square.selected {
            border-color: #667eea;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
            border-radius: 8px !important;
        }

        .node.node-shape-ellipse.selected {
            border-color: #667eea;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
            border-radius: 50% !important;
        }

        .node.node-shape-circle.selected {
            border-color: #667eea;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
            border-radius: 50% !important;
        }

        .node.editing {
            border-color: #4CAF50;
        }

        .node.dragging {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: grabbing;
            transition: none;
        }

        .node.node-shape-square.dragging {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: grabbing;
            transition: none;
            border-radius: 8px !important;
        }

        .node.node-shape-ellipse.dragging {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: grabbing;
            transition: none;
            border-radius: 50% !important;
        }

        .node.node-shape-circle.dragging {
            transform: scale(1.05);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: grabbing;
            transition: none;
            border-radius: 50% !important;
        }

        .node.drag-placeholder {
            opacity: 0.3;
            transform: scale(0.95);
        }

        .node.resize-mode {
            border-color: #2ed573;
            box-shadow: 0 12px 40px rgba(46, 213, 115, 0.3);
            cursor: nw-resize;
        }

        .node.node-shape-circle.resize-mode {
            border-color: #2ed573;
            box-shadow: 0 12px 40px rgba(46, 213, 115, 0.3);
            cursor: nw-resize;
            border-radius: 50% !important;
        }

        .node.resizing {
            border-color: #2ed573;
            box-shadow: 0 20px 60px rgba(46, 213, 115, 0.4);
            cursor: nw-resize;
        }

        .node.node-shape-ellipse.resize-mode {
            border-color: #2ed573;
            box-shadow: 0 12px 40px rgba(46, 213, 115, 0.3);
            cursor: nw-resize;
            border-radius: 50% !important;
        }

        .node.node-shape-ellipse.resizing {
            border-color: #2ed573;
            box-shadow: 0 20px 60px rgba(46, 213, 115, 0.4);
            cursor: nw-resize;
            border-radius: 50% !important;
        }

        .node.node-shape-square.resize-mode {
            border-color: #2ed573;
            box-shadow: 0 12px 40px rgba(46, 213, 115, 0.3);
            cursor: nw-resize;
            border-radius: 8px !important;
        }

        .node.node-shape-square.resizing {
            border-color: #2ed573;
            box-shadow: 0 20px 60px rgba(46, 213, 115, 0.4);
            cursor: nw-resize;
            border-radius: 8px !important;
        }

        .node.node-shape-circle.resizing {
            border-color: #2ed573;
            box-shadow: 0 20px 60px rgba(46, 213, 115, 0.4);
            cursor: nw-resize;
            border-radius: 50% !important;
        }

        .node input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            width: 100%;
            min-width: 50px;
            max-width: 300px;
            color: #000000;
        }

        .node-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            width: 100%;
            height: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            color: #000000;
        }

        .connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: var(--connection-color);
            stroke-width: 3;
            fill: none;
            opacity: 0.7;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: stroke 0.3s ease;
        }

        .node-controls {
            position: absolute;
            top: -15px;
            right: -15px;
            display: none;
            gap: 5px;
        }

        .node.selected .node-controls {
            display: flex;
        }

        .node-controls-expanded {
            display: none;
            gap: 5px;
            animation: expandControls 0.3s ease;
        }

        .node-controls-expanded.show {
            display: flex;
        }

        @keyframes expandControls {
            from {
                opacity: 0;
                transform: translateX(-10px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .control-btn.settings {
            background: #667eea;
            color: white;
            font-size: 14px;
        }

        .control-btn.settings:hover {
            background: #5a6fd8;
            transform: rotate(90deg);
        }

        .control-btn.delete {
            background: #ff4757;
            color: white;
        }

        .control-btn.connect {
            background: #667eea;
            color: white;
        }

        .control-btn.disconnect {
            background: #ffa502;
            color: white;
        }

        .control-btn.resize {
            background: #2ed573;
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .stats {
            margin-top: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .stats h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .signature {
            width: 100%;
            height: 120px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .signature-text {
            text-align: center;
        }

        .signature-line1 {
            margin: 0;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            line-height: 1.2;
        }

        .signature-line2 {
            margin: 0;
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2;
            margin-top: 2px;
        }

        .export-options {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-selector {
            margin-top: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .theme-selector h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .theme-option {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .theme-option.active {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-default {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .theme-blue {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            color: #1976D2;
        }

        .theme-green {
            background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
            color: #1B5E20;
        }

        .theme-white {
            background: linear-gradient(135deg, #FAFAFA, #F5F5F5);
            color: #212121;
            border: 1px solid #E0E0E0;
        }

        .floating-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background: #667eea;
            color: white;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            transform: scale(1.1);
        }

        .zoom-level {
            margin: 0 10px;
            font-weight: 600;
            color: #667eea;
            min-width: 50px;
            text-align: center;
        }

        .shape-selector {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            padding: 25px;
            display: none;
            z-index: 1000;
            border: 2px solid rgba(102, 126, 234, 0.2);
            animation: shapeSelectorAppear 0.3s ease;
            min-width: 280px;
        }

        .shape-selector.show {
            display: block;
        }

        .shape-selector h3 {
            color: #667eea;
            margin: 0 0 20px 0;
            font-size: 18px;
            text-align: center;
            font-weight: 600;
        }

        .shape-selector-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .shape-selector-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background: rgba(102, 126, 234, 0.05);
        }

        .shape-selector-option:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .shape-selector-option.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .shape-selector-preview {
            width: 50px;
            height: 50px;
            background: #667eea;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .shape-selector-preview.rectangle {
            border-radius: 8px;
            width: 60px;
            height: 35px;
        }

        .shape-selector-preview.square {
            border-radius: 4px;
            width: 40px;
            height: 40px;
        }

        .shape-selector-preview.circle {
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .shape-selector-preview.ellipse {
            border-radius: 50%;
            width: 50px;
            height: 30px;
        }

        .shape-selector-label {
            font-size: 14px;
            font-weight: 500;
            color: #667eea;
            text-align: center;
        }


        @keyframes shapeSelectorAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .disconnect-menu {
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            padding: 15px;
            display: none;
            z-index: 1001;
            border: 2px solid rgba(255, 165, 2, 0.3);
            min-width: 200px;
            max-height: 200px;
            overflow-y: auto;
        }

        .disconnect-menu.show {
            display: block;
            animation: shapeSelectorAppear 0.3s ease;
        }

        .disconnect-menu h4 {
            color: #ffa502;
            margin: 0 0 10px 0;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
        }

        .disconnect-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 5px;
            background: rgba(255, 165, 2, 0.05);
            border: 1px solid transparent;
        }

        .disconnect-option:hover {
            background: rgba(255, 165, 2, 0.15);
            border-color: rgba(255, 165, 2, 0.3);
            transform: translateX(2px);
        }

        .disconnect-option:last-child {
            margin-bottom: 0;
        }

        .disconnect-option-text {
            font-size: 12px;
            color: #666;
            flex: 1;
            margin-right: 8px;
        }

        .disconnect-option-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .disconnect-option-btn:hover {
            background: #ff3742;
            transform: scale(1.05);
        }

        /* Anima√ß√µes */
        @keyframes nodeAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .node-appear {
            animation: nodeAppear 0.4s ease;
        }

        /* Melhorias para touch */
        @media (hover: none) and (pointer: coarse) {
            .node:hover {
                transform: none;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }
            
            .btn:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            
            .control-btn:hover {
                transform: none;
                background: rgba(102, 126, 234, 0.2);
            }
            
            .shape-option:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            
            .color-option:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }
        }

        /* Mobile Toolkit Styles */
        .mobile-toolkit {
            display: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mobile-toolkit.collapsed {
            transform: translateY(100%);
        }

        .mobile-toolkit.collapsed.landscape {
            transform: translateX(-100%);
        }

        /* Mobile Collapse Button */
        .mobile-collapse-btn {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 40px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: none;
            border-radius: 20px 20px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-collapse-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15);
        }

        .mobile-collapse-btn:active {
            transform: translateX(-50%) translateY(0);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .collapse-icon {
            font-size: 16px;
            color: var(--primary-color);
            transition: transform 0.3s ease;
        }

        .mobile-toolkit.collapsed .collapse-icon {
            transform: rotate(180deg);
        }

        /* Landscape Collapse Button */
        .mobile-toolkit.landscape .mobile-collapse-btn {
            top: 50%;
            left: 260px;
            right: auto;
            transform: translateY(-50%);
            width: 40px;
            height: 60px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-right: none;
            border-radius: 0 20px 20px 0;
        }

        .mobile-toolkit.landscape .mobile-collapse-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-50%) translateX(-2px);
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15);
        }

        .mobile-toolkit.landscape .mobile-collapse-btn:active {
            transform: translateY(-50%) translateX(0);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-toolkit.landscape .collapse-icon {
            transform: rotate(-90deg);
        }

        .mobile-toolkit.landscape.collapsed .collapse-icon {
            transform: rotate(90deg);
        }

        /* Mobile Sidebar Styles */
        .mobile-tabs {
            display: none;
        }

        .mobile-tab-content {
            display: none;
        }

        .mobile-section {
            display: none;
        }

        .mobile-button-grid {
            display: none;
        }

        .mobile-shape-grid {
            display: none;
        }

        .mobile-color-grid {
            display: none;
        }

        .mobile-theme-grid {
            display: none;
        }

        .mobile-footer {
            display: none;
        }

        /* Responsivo - Tablet */
        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar {
                width: 250px;
            }
            
            .floating-toolbar {
                top: 15px;
                right: 15px;
                padding: 12px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* Responsivo - Mobile */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }
            
            /* Hide desktop sidebar */
            .desktop-sidebar {
                display: none !important;
            }
            
            /* Show mobile toolkit */
            .mobile-toolkit {
                display: block;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--sidebar-bg);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                height: 40vh;
                max-height: 40vh;
            }

            .mobile-toolkit.collapsed {
                transform: translateY(calc(100% - 40px));
            }

            .mobile-toolkit.collapsed .mobile-tab-content {
                display: none;
            }

            .mobile-toolkit.collapsed .mobile-footer {
                display: none;
            }
            
            .canvas-container {
                height: 60vh;
                min-height: 300px;
                position: relative;
                margin-bottom: 0;
            }
            
            /* Mobile Tabs */
            .mobile-tabs {
                display: flex;
                background: rgba(255, 255, 255, 0.05);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 8px 0;
            }

            .mobile-tab {
                flex: 1;
                background: transparent;
                border: none;
                padding: 8px 4px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                position: relative;
                min-height: 50px;
            }

            .mobile-tab.active {
                background: rgba(102, 126, 234, 0.1);
                color: var(--primary-color);
            }

            .mobile-tab.active::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: var(--primary-color);
                border-radius: 2px 2px 0 0;
            }

            .tab-icon {
                font-size: 14px;
            }

            .tab-label {
                font-size: 9px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                line-height: 1;
            }

            .tab-stats {
                font-size: 8px;
                font-weight: 700;
                background: var(--primary-color);
                color: white;
                padding: 2px 4px;
                border-radius: 6px;
                min-width: 16px;
                text-align: center;
                line-height: 1;
            }

            .mobile-tab.active .tab-stats {
                background: white;
                color: var(--primary-color);
            }

            /* Mobile Tab Content */
            .mobile-tab-content {
                display: block;
                height: calc(40vh - 70px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 12px;
            }

            .tab-panel {
                display: none;
            }

            .tab-panel.active {
                display: block;
            }

            /* Mobile Sections */
            .mobile-section {
                display: block;
                margin-bottom: 20px;
            }

            .section-title {
                font-size: 14px;
                font-weight: 600;
                color: var(--primary-color);
                margin: 0 0 12px 0;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .subsection-title {
                font-size: 12px;
                font-weight: 500;
                color: var(--text-color);
                margin: 12px 0 8px 0;
                opacity: 0.8;
            }

            /* Mobile Button Grid */
            .mobile-button-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .mobile-btn {
                background: white;
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 12px;
                padding: 12px 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                min-height: 60px;
                touch-action: manipulation;
            }

            .mobile-btn.primary {
                background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                color: white;
                border-color: transparent;
            }

            .mobile-btn.secondary {
                background: rgba(255, 255, 255, 0.9);
                color: var(--text-color);
            }

            .mobile-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            .btn-icon {
                font-size: 18px;
            }

            .btn-text {
                font-size: 11px;
                font-weight: 600;
                text-align: center;
                line-height: 1.2;
            }

            /* Mobile Shape Grid */
            .mobile-shape-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .mobile-shape-btn {
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 12px;
                padding: 12px 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                min-height: 70px;
                touch-action: manipulation;
            }

            .mobile-shape-btn.active {
                border-color: var(--primary-color);
                background: rgba(102, 126, 234, 0.1);
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
            }

            .mobile-shape-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            .shape-label {
                font-size: 10px;
                font-weight: 600;
                color: var(--text-color);
                text-align: center;
            }

            /* Mobile Color Grid */
            .mobile-color-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .mobile-color-btn {
                width: 100%;
                height: 44px;
                border: 3px solid transparent;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                touch-action: manipulation;
            }

            .mobile-color-btn.active {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
                transform: scale(1.05);
            }

            .mobile-color-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            /* Custom Color Mobile */
            .custom-color-mobile {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 12px;
            }

            .mobile-color-picker {
                flex: 1;
                height: 44px;
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 12px;
                cursor: pointer;
                background: transparent;
            }

            .mobile-color-picker::-webkit-color-swatch-wrapper {
                padding: 0;
                border-radius: 10px;
                border: none;
            }

            .mobile-color-picker::-webkit-color-swatch {
                border: none;
                border-radius: 8px;
            }

            /* Recent Colors Mobile */
            .recent-colors-mobile {
                margin-top: 12px;
            }

            .recent-colors-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            /* Mobile Theme Grid */
            .mobile-theme-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .mobile-theme-btn {
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 12px;
                padding: 12px 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                min-height: 70px;
                touch-action: manipulation;
            }

            .mobile-theme-btn.active {
                border-color: var(--primary-color);
                background: rgba(102, 126, 234, 0.1);
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
            }

            .mobile-theme-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            .theme-preview {
                width: 32px;
                height: 20px;
                border-radius: 6px;
                border: 1px solid rgba(0, 0, 0, 0.1);
            }

            .theme-label {
                font-size: 10px;
                font-weight: 600;
                color: var(--text-color);
                text-align: center;
            }

            /* Mobile Stats Detailed */
            .mobile-stats-detailed {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .stat-item-mobile {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
                border: 1px solid rgba(102, 126, 234, 0.1);
            }

            .stat-icon {
                font-size: 14px;
            }

            .stat-label {
                font-size: 12px;
                font-weight: 500;
                color: var(--text-color);
                flex: 1;
            }

            .stat-value {
                font-size: 14px;
                font-weight: 700;
                color: var(--primary-color);
            }

            /* Mobile Footer */
            .mobile-footer {
                display: block;
                padding: 12px 16px;
                background: rgba(102, 126, 234, 0.05);
                border-top: 1px solid rgba(102, 126, 234, 0.1);
                text-align: center;
            }

            .signature-mobile {
                font-size: 11px;
                color: var(--primary-color);
                font-weight: 500;
                opacity: 0.8;
            }

            /* Melhorias adicionais para mobile */
            .mobile-tab-content::-webkit-scrollbar {
                width: 4px;
            }

            .mobile-tab-content::-webkit-scrollbar-track {
                background: rgba(102, 126, 234, 0.1);
                border-radius: 2px;
            }

            .mobile-tab-content::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.3);
                border-radius: 2px;
            }

            .mobile-tab-content::-webkit-scrollbar-thumb:hover {
                background: rgba(102, 126, 234, 0.5);
            }

            /* Anima√ß√µes suaves para transi√ß√µes de abas */
            .tab-panel {
                animation: fadeIn 0.3s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Melhorar feedback visual para bot√µes mobile */
            .mobile-btn:active,
            .mobile-shape-btn:active,
            .mobile-color-btn:active,
            .mobile-theme-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .toolbar {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .btn {
                padding: 12px 8px;
                font-size: 12px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                line-height: 1.2;
            }
            
            .floating-toolbar {
                top: 8px;
                right: 8px;
                padding: 8px;
                flex-direction: row;
                gap: 8px;
                background: rgba(255, 255, 255, 0.98);
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }
            
            .zoom-controls {
                flex-direction: row;
                gap: 4px;
                align-items: center;
            }
            
            .zoom-btn {
                width: 36px;
                height: 36px;
                padding: 0;
                font-size: 16px;
                font-weight: bold;
                min-height: 36px;
            }
            
            .zoom-level {
                font-size: 11px;
                padding: 4px 6px;
                min-width: 40px;
                text-align: center;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 6px;
            }
            
            .node {
                min-width: 60px;
                min-height: 44px;
                font-size: 11px;
                padding: 8px 10px;
                border-radius: 20px;
            }
            
            .node-controls {
                gap: 4px;
                top: -12px;
                right: -12px;
            }
            
            .control-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
                min-width: 28px;
                min-height: 28px;
            }
            
            .shape-palette {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-top: 10px;
            }
            
            .shape-option {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
            }
            
            .shape-preview {
                width: 20px;
                height: 20px;
            }
            
            .rectangle-preview {
                width: 24px;
                height: 16px;
            }
            
            .square-preview {
                width: 18px;
                height: 18px;
            }
            
            .circle-preview {
                width: 18px;
                height: 18px;
            }
            
            .ellipse-preview {
                width: 22px;
                height: 14px;
            }
            
            .color-palette {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-top: 10px;
            }
            
            .color-option {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
            }
            
            .custom-color-section {
                margin-top: 10px;
                padding: 10px;
            }
            
            .custom-color-picker {
                height: 40px;
                min-height: 40px;
            }
            
            .recent-colors-section {
                margin-top: 10px;
                padding: 10px;
            }
            
            .recent-colors-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .recent-color-option {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
            }
            
            .theme-selector {
                margin-top: 15px;
                padding: 10px;
            }
            
            .theme-options {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .theme-option {
                padding: 8px 6px;
                font-size: 11px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .export-options {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                margin-top: 15px;
            }
            
            .export-options .btn {
                padding: 10px 6px;
                font-size: 11px;
                min-height: 40px;
            }
            
            .stats {
                margin-top: 15px;
                padding: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .stats h3 {
                font-size: 14px;
                margin-bottom: 0;
            }
            
            .stat-item {
                font-size: 12px;
                margin: 4px 0;
            }
            
            .signature {
                height: 60px;
                margin-top: 10px;
                padding: 8px;
            }
            
            .signature-line1 {
                font-size: 12px;
            }
            
            .signature-line2 {
                font-size: 10px;
            }
            
            /* Melhorar seletor de formas para mobile */
            .shape-selector {
                max-width: 90vw;
                max-height: 60vh;
                padding: 20px;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%);
                position: fixed;
            }
            
            .shape-selector-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .shape-selector-option {
                padding: 15px;
                min-height: 80px;
            }
            
            .shape-selector-preview {
                width: 40px;
                height: 40px;
                margin-bottom: 8px;
            }
            
            .shape-selector-label {
                font-size: 12px;
            }
            
            /* Melhorar menu de desconex√£o para mobile */
            .disconnect-menu {
                max-width: 90vw;
                max-height: 50vh;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%);
                position: fixed;
            }
            
            .disconnect-option {
                padding: 10px 12px;
                min-height: 44px;
            }
            
            .disconnect-option-text {
                font-size: 13px;
            }
            
            .disconnect-option-btn {
                padding: 6px 10px;
                font-size: 11px;
                min-height: 32px;
            }
        }
        
        /* Responsivo - Mobile Pequeno */
        @media (max-width: 480px) {
            .sidebar {
                max-height: 35vh;
                padding: 8px;
            }
            
            .canvas-container {
                height: 65vh;
                min-height: 250px;
            }
            
            .toolbar {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 10px;
            }
            
            .btn {
                padding: 10px 6px;
                font-size: 11px;
                min-height: 40px;
                line-height: 1.1;
            }
            
            .floating-toolbar {
                top: 5px;
                right: 5px;
                padding: 6px;
                gap: 4px;
            }
            
            .zoom-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
                min-height: 32px;
            }
            
            .zoom-level {
                font-size: 10px;
                padding: 2px 4px;
                min-width: 35px;
            }
            
            .node {
                min-width: 50px;
                min-height: 40px;
                font-size: 10px;
                padding: 6px 8px;
                border-radius: 18px;
            }
            
            .node-controls {
                gap: 3px;
                top: -10px;
                right: -10px;
            }
            
            .control-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
                min-width: 24px;
                min-height: 24px;
            }
            
            .shape-palette {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
                margin-top: 8px;
            }
            
            .shape-option {
                width: 32px;
                height: 32px;
                min-width: 32px;
                min-height: 32px;
            }
            
            .shape-preview {
                width: 18px;
                height: 18px;
            }
            
            .rectangle-preview {
                width: 20px;
                height: 14px;
            }
            
            .square-preview {
                width: 16px;
                height: 16px;
            }
            
            .circle-preview {
                width: 16px;
                height: 16px;
            }
            
            .ellipse-preview {
                width: 18px;
                height: 12px;
            }
            
            .color-palette {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
                margin-top: 8px;
            }
            
            .color-option {
                width: 32px;
                height: 32px;
                min-width: 32px;
                min-height: 32px;
            }
            
            .custom-color-section {
                margin-top: 8px;
                padding: 8px;
            }
            
            .custom-color-picker {
                height: 36px;
                min-height: 36px;
            }
            
            .recent-colors-section {
                margin-top: 8px;
                padding: 8px;
            }
            
            .recent-colors-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }
            
            .recent-color-option {
                width: 32px;
                height: 32px;
                min-width: 32px;
                min-height: 32px;
            }
            
            .theme-selector {
                margin-top: 10px;
                padding: 8px;
            }
            
            .theme-options {
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .theme-option {
                padding: 6px 4px;
                font-size: 10px;
                min-height: 36px;
            }
            
            .export-options {
                grid-template-columns: 1fr;
                gap: 4px;
                margin-top: 10px;
            }
            
            .export-options .btn {
                padding: 8px 4px;
                font-size: 10px;
                min-height: 36px;
            }
            
            .stats {
                margin-top: 10px;
                padding: 8px;
                flex-direction: column;
                gap: 4px;
                align-items: center;
            }
            
            .stats h3 {
                font-size: 12px;
                margin-bottom: 4px;
            }
            
            .stat-item {
                font-size: 11px;
                margin: 2px 0;
            }
            
            .signature {
                height: 50px;
                margin-top: 8px;
                padding: 6px;
            }
            
            .signature-line1 {
                font-size: 11px;
            }
            
            .signature-line2 {
                font-size: 9px;
            }
            
            /* Melhorar seletor de formas para telas muito pequenas */
            .shape-selector {
                max-width: 95vw;
                max-height: 70vh;
                padding: 15px;
            }
            
            .shape-selector-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .shape-selector-option {
                padding: 12px;
                min-height: 70px;
            }
            
            .shape-selector-preview {
                width: 35px;
                height: 35px;
                margin-bottom: 6px;
            }
            
            .shape-selector-label {
                font-size: 11px;
            }
            
            /* Melhorar menu de desconex√£o para telas muito pequenas */
            .disconnect-menu {
                max-width: 95vw;
                max-height: 60vh;
                padding: 12px;
            }
            
            .disconnect-option {
                padding: 8px 10px;
                min-height: 40px;
            }
            
            .disconnect-option-text {
                font-size: 12px;
            }
            
            .disconnect-option-btn {
                padding: 4px 8px;
                font-size: 10px;
                min-height: 28px;
            }
        }
        
        /* Melhorias espec√≠ficas para mobile */
        @media (max-width: 768px) {
            /* Melhorar √°rea de toque */
            .node {
                min-height: 44px; /* Tamanho m√≠nimo recomendado para touch */
                touch-action: manipulation;
            }
            
            .btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .control-btn {
                min-width: 44px;
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .shape-option {
                min-width: 44px;
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .color-option {
                min-width: 44px;
                min-height: 44px;
                touch-action: manipulation;
            }
            
            /* Melhorar scroll na sidebar */
            .sidebar {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            /* Melhorar canvas para touch */
            .canvas {
                touch-action: pan-x pan-y pinch-zoom;
            }
            
            /* Melhorar feedback visual para touch */
            .node:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .control-btn:active {
                transform: scale(0.9);
                transition: transform 0.1s ease;
            }
            
            .shape-option:active {
                transform: scale(0.9);
                transition: transform 0.1s ease;
            }
            
            .color-option:active {
                transform: scale(0.9);
                transition: transform 0.1s ease;
            }
            
            /* Melhorar visibilidade dos controles em mobile */
            .node-controls {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 4px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }
            
            /* Melhorar legibilidade do texto */
            .node {
                font-weight: 600;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            /* Melhorar contraste dos bot√µes */
            .btn-primary {
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }
            
            .btn-secondary {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            /* Melhorar indicadores visuais */
            .color-option.active {
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
            }
            
            .shape-option.active {
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
            }
            
            .theme-option.active {
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
            }
        }
        
        /* Melhorias para orienta√ß√£o landscape em mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                flex-direction: row;
            }
            
            /* Hide desktop sidebar */
            .desktop-sidebar {
                display: none !important;
            }
            
            /* Show mobile toolkit on the left */
            .mobile-toolkit {
                display: block;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 35vw;
                max-width: 300px;
                min-width: 250px;
                background: var(--sidebar-bg);
                backdrop-filter: blur(10px);
                border-right: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                height: 100vh;
                max-height: 100vh;
            }


            .mobile-toolkit.landscape.collapsed {
                transform: translateX(calc(-100% + 40px));
            }

            .mobile-toolkit.landscape.collapsed .mobile-tab-content {
                display: none;
            }

            .mobile-toolkit.landscape.collapsed .mobile-footer {
                display: none;
            }
            
            .canvas-container {
                margin-left: 35vw;
                width: 65vw;
                height: 100vh;
                min-height: 100vh;
            }
            
            /* Mobile Tabs - Landscape */
            .mobile-tabs {
                display: flex;
                background: rgba(255, 255, 255, 0.05);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 6px 0;
            }

            .mobile-tab {
                flex: 1;
                background: transparent;
                border: none;
                padding: 6px 2px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                position: relative;
                min-height: 45px;
            }

            .tab-icon {
                font-size: 12px;
            }

            .tab-label {
                font-size: 8px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                line-height: 1;
            }

            .tab-stats {
                font-size: 7px;
                font-weight: 700;
                background: var(--primary-color);
                color: white;
                padding: 1px 3px;
                border-radius: 6px;
                min-width: 14px;
                text-align: center;
                line-height: 1;
            }

            /* Mobile Tab Content - Landscape */
            .mobile-tab-content {
                display: block;
                height: calc(100vh - 60px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 8px;
            }

            /* Mobile Button Grid - Landscape */
            .mobile-button-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .mobile-btn {
                background: white;
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 10px;
                padding: 8px 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                min-height: 40px;
                touch-action: manipulation;
            }

            .btn-icon {
                font-size: 14px;
            }

            .btn-text {
                font-size: 10px;
                font-weight: 600;
                text-align: left;
                line-height: 1.2;
            }

            /* Mobile Shape Grid - Landscape */
            .mobile-shape-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .mobile-shape-btn {
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 10px;
                padding: 8px 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                min-height: 40px;
                touch-action: manipulation;
            }

            .shape-label {
                font-size: 9px;
                font-weight: 600;
                color: var(--text-color);
                text-align: left;
            }

            /* Mobile Color Grid - Landscape */
            .mobile-color-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .mobile-color-btn {
                width: 100%;
                height: 36px;
                border: 3px solid transparent;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                touch-action: manipulation;
            }

            /* Custom Color Mobile - Landscape */
            .custom-color-mobile {
                display: flex;
                gap: 6px;
                align-items: center;
                margin-bottom: 8px;
            }

            .mobile-color-picker {
                flex: 1;
                height: 36px;
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 10px;
                cursor: pointer;
                background: transparent;
            }

            /* Recent Colors Mobile - Landscape */
            .recent-colors-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }

            /* Mobile Theme Grid - Landscape */
            .mobile-theme-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .mobile-theme-btn {
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid rgba(102, 126, 234, 0.2);
                border-radius: 10px;
                padding: 8px 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                min-height: 40px;
                touch-action: manipulation;
            }

            .theme-preview {
                width: 24px;
                height: 16px;
                border-radius: 4px;
                border: 1px solid rgba(0, 0, 0, 0.1);
            }

            .theme-label {
                font-size: 9px;
                font-weight: 600;
                color: var(--text-color);
                text-align: left;
            }

            /* Mobile Stats Detailed - Landscape */
            .mobile-stats-detailed {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .stat-item-mobile {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 8px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 6px;
                border: 1px solid rgba(102, 126, 234, 0.1);
            }

            .stat-icon {
                font-size: 12px;
            }

            .stat-label {
                font-size: 10px;
                font-weight: 500;
                color: var(--text-color);
                flex: 1;
            }

            .stat-value {
                font-size: 12px;
                font-weight: 700;
                color: var(--primary-color);
            }

            /* Mobile Footer - Landscape */
            .mobile-footer {
                display: block;
                padding: 8px 12px;
                background: rgba(102, 126, 234, 0.05);
                border-top: 1px solid rgba(102, 126, 234, 0.1);
                text-align: center;
            }

            .signature-mobile {
                font-size: 9px;
                color: var(--primary-color);
                font-weight: 500;
                opacity: 0.8;
            }
            
            .floating-toolbar {
                top: 5px;
                right: 5px;
                padding: 6px;
            }
            
            .zoom-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }
        
        /* Melhorias para dispositivos com tela muito alta */
        @media (max-width: 768px) and (min-height: 800px) {
            .sidebar {
                max-height: 35vh;
            }
            
            .canvas-container {
                height: 65vh;
            }
            
            .toolbar {
                margin-bottom: 20px;
            }
            
            .stats {
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Desktop Sidebar -->
        <div class="sidebar desktop-sidebar">
            <div class="logo">Mapa Mental </div>
           
            <div class="toolbar">
                <button class="btn btn-primary" onclick="addNode()">
                    ‚ûï Adicionar N√≥
                </button>
               
                <button id="clearButton" class="btn btn-secondary" onclick="clearCanvas()">
                    üóëÔ∏è Limpar Tudo
                </button>
                
                <!-- <button class="btn btn-secondary" onclick="adjustAllTextSizes()" title="Ajustar tamanho do texto de todos os n√≥s">
                    üìù Ajustar Texto
                </button> -->
               
                <h4 style="margin-top: 20px; color: #667eea;">Formatos dos N√≥s</h4>
                <div class="shape-palette">
                    <div class="shape-option active" onclick="setNodeShape('rectangle')" title="Retangular">
                        <div class="shape-preview rectangle-preview"></div>
                    </div>
                    <div class="shape-option" onclick="setNodeShape('square')" title="Quadrado">
                        <div class="shape-preview square-preview"></div>
                    </div>
                    <div class="shape-option" onclick="setNodeShape('circle')" title="Circular">
                        <div class="shape-preview circle-preview"></div>
                    </div>
                    <div class="shape-option" onclick="setNodeShape('ellipse')" title="Elipse">
                        <div class="shape-preview ellipse-preview"></div>
                    </div>
                </div>
                <h4 style="margin-top: 20px; color: #667eea;">Cores dos N√≥s</h4>
                <div class="color-palette">
                    <div class="color-option active" style="background: #ffffff;" onclick="setNodeColor('#ffffff')"></div>
                    <div class="color-option" style="background: #ff4757;" onclick="setNodeColor('#ff4757')"></div>
                    <div class="color-option" style="background: #2ed573;" onclick="setNodeColor('#2ed573')"></div>
                    <div class="color-option" style="background: #3742fa;" onclick="setNodeColor('#3742fa')"></div>
                    <div class="color-option" style="background: #ffa502;" onclick="setNodeColor('#ffa502')"></div>
                    <div class="color-option" style="background: #ff6348;" onclick="setNodeColor('#ff6348')"></div>
                    <div class="color-option" style="background: #2f3542;" onclick="setNodeColor('#2f3542')"></div>
                    <div class="color-option" style="background: #ff9ff3;" onclick="setNodeColor('#ff9ff3')"></div>
                </div>
                
                <h4 style="margin-top: 20px; color: #667eea;">Cor Personalizada</h4>
                <div class="custom-color-section">
                    <input type="color" id="customColorPicker" class="custom-color-picker" value="#667eea" onchange="setCustomNodeColor(this.value)">
                    <button class="btn btn-secondary" onclick="applyCustomColor()" style="margin-top: 10px; width: 100%;">
                        üé® Aplicar Cor
                    </button>
                    <div class="recent-colors-section">
                        <div class="recent-colors-grid" id="recentColorsGrid">
                        </div>
                </div>
                
                
                </div>
               
                
               
                <div class="export-options">
                    <button class="btn btn-secondary" onclick="exportAsPNG()">
                        üì∏ Exportar PNG
                    </button>
                    <button class="btn btn-secondary" onclick="exportAsJSON()">
                        üíæ Salvar Projeto
                    </button>
                    <button class="btn btn-secondary" onclick="importJSON()">
                        üìÅ Carregar Projeto
                    </button>
                </div>

                <div class="theme-selector">
                    <h4>üé® Temas</h4>
                    <div class="theme-options">
                        <div class="theme-option theme-default active" onclick="changeTheme('default')" data-theme="default">
                            Padr√£o
                        </div>
                        <div class="theme-option theme-blue" onclick="changeTheme('blue')" data-theme="blue">
                            Azul Claro
                        </div>
                        <div class="theme-option theme-green" onclick="changeTheme('green')" data-theme="green">
                            Verde
                        </div>
                        <div class="theme-option theme-white" onclick="changeTheme('white')" data-theme="white">
                            Branco
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="stats">
                <h3>Estat√≠sticas</h3>
                <div class="stat-item">
                    <span>N√≥s:</span>
                    <span id="nodeCount">0</span>
                </div>
                <div class="stat-item">
                    <span>Conex√µes:</span>
                    <span id="connectionCount">0</span>
                </div>
            </div>
           
            <div class="signature">
                <div class="signature-text">
                    <div class="signature-line1">S(i)S</div>
                    <div class="signature-line2">Morphyro</div>

                </div>
            </div>
        </div>

        <!-- Mobile Toolkit -->
        <div class="mobile-toolkit" id="mobileToolkit">
            <!-- Mobile Tab Navigation -->
            <div class="mobile-tabs">
                <!-- Collapse/Expand Button -->
                <button class="mobile-collapse-btn" onclick="toggleMobileToolkit()" id="mobileCollapseBtn">
                    <span class="collapse-icon">‚ñº</span>
                </button>
                <button class="mobile-tab active" data-tab="tools" onclick="switchMobileTab('tools')">
                    <span class="tab-icon">üõ†Ô∏è</span>
                    <span class="tab-label">Ferramentas</span>
                    <span class="tab-stats" id="toolsStats">0</span>
                </button>
                <button class="mobile-tab" data-tab="design" onclick="switchMobileTab('design')">
                    <span class="tab-icon">üé®</span>
                    <span class="tab-label">Design</span>
                    <span class="tab-stats" id="designStats">0</span>
                </button>
                <button class="mobile-tab" data-tab="export" onclick="switchMobileTab('export')">
                    <span class="tab-icon">üì§</span>
                    <span class="tab-label">Exportar</span>
                    <span class="tab-stats" id="exportStats">0</span>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="mobile-tab-content">
                <!-- Tools Tab -->
                <div class="tab-panel active" id="tools-panel">
                    <div class="mobile-section">
                        <h4 class="section-title">A√ß√µes Principais</h4>
                        <div class="mobile-button-grid">
                            <button class="mobile-btn primary" onclick="addNode()">
                                <span class="btn-icon">‚ûï</span>
                                <span class="btn-text">Novo N√≥</span>
                            </button>
                            <button id="clearButtonMobile" class="mobile-btn secondary" onclick="clearCanvas()">
                                <span class="btn-icon">üóëÔ∏è</span>
                                <span class="btn-text">Limpar</span>
                            </button>
                        </div>
                    </div>

                    <div class="mobile-section">
                        <h4 class="section-title">Formas</h4>
                        <div class="mobile-shape-grid">
                            <button class="mobile-shape-btn active" onclick="setNodeShape('rectangle')" data-shape="rectangle">
                                <div class="shape-preview rectangle-preview"></div>
                                <span class="shape-label">Ret√¢ngulo</span>
                            </button>
                            <button class="mobile-shape-btn" onclick="setNodeShape('square')" data-shape="square">
                                <div class="shape-preview square-preview"></div>
                                <span class="shape-label">Quadrado</span>
                            </button>
                            <button class="mobile-shape-btn" onclick="setNodeShape('circle')" data-shape="circle">
                                <div class="shape-preview circle-preview"></div>
                                <span class="shape-label">C√≠rculo</span>
                            </button>
                            <button class="mobile-shape-btn" onclick="setNodeShape('ellipse')" data-shape="ellipse">
                                <div class="shape-preview ellipse-preview"></div>
                                <span class="shape-label">Elipse</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Design Tab -->
                <div class="tab-panel" id="design-panel">
                    <div class="mobile-section">
                        <h4 class="section-title">Cores R√°pidas</h4>
                        <div class="mobile-color-grid">
                            <button class="mobile-color-btn active" style="background: #ffffff;" onclick="setNodeColor('#ffffff')" data-color="#ffffff"></button>
                            <button class="mobile-color-btn" style="background: #ff4757;" onclick="setNodeColor('#ff4757')" data-color="#ff4757"></button>
                            <button class="mobile-color-btn" style="background: #2ed573;" onclick="setNodeColor('#2ed573')" data-color="#2ed573"></button>
                            <button class="mobile-color-btn" style="background: #3742fa;" onclick="setNodeColor('#3742fa')" data-color="#3742fa"></button>
                            <button class="mobile-color-btn" style="background: #ffa502;" onclick="setNodeColor('#ffa502')" data-color="#ffa502"></button>
                            <button class="mobile-color-btn" style="background: #ff6348;" onclick="setNodeColor('#ff6348')" data-color="#ff6348"></button>
                            <button class="mobile-color-btn" style="background: #2f3542;" onclick="setNodeColor('#2f3542')" data-color="#2f3542"></button>
                            <button class="mobile-color-btn" style="background: #ff9ff3;" onclick="setNodeColor('#ff9ff3')" data-color="#ff9ff3"></button>
                        </div>
                    </div>

                    <div class="mobile-section">
                        <h4 class="section-title">Cor Personalizada</h4>
                        <div class="custom-color-mobile">
                            <input type="color" id="mobileCustomColorPicker" class="mobile-color-picker" onchange="setCustomNodeColor(this.value)">
                            <button class="mobile-btn secondary" onclick="applyCustomColor()">
                                <span class="btn-icon">üé®</span>
                                <span class="btn-text">Aplicar</span>
                            </button>
                        </div>
                        <div class="recent-colors-mobile">
                            <h5 class="subsection-title">Cores Recentes</h5>
                            <div class="recent-colors-grid" id="mobileRecentColorsGrid"></div>
                        </div>
                    </div>

                    <div class="mobile-section">
                        <h4 class="section-title">Temas</h4>
                        <div class="mobile-theme-grid">
                            <button class="mobile-theme-btn active" onclick="changeTheme('default')" data-theme="default">
                                <div class="theme-preview theme-default"></div>
                                <span class="theme-label">Padr√£o</span>
                            </button>
                            <button class="mobile-theme-btn" onclick="changeTheme('blue')" data-theme="blue">
                                <div class="theme-preview theme-blue"></div>
                                <span class="theme-label">Azul</span>
                            </button>
                            <button class="mobile-theme-btn" onclick="changeTheme('green')" data-theme="green">
                                <div class="theme-preview theme-green"></div>
                                <span class="theme-label">Verde</span>
                            </button>
                            <button class="mobile-theme-btn" onclick="changeTheme('white')" data-theme="white">
                                <div class="theme-preview theme-white"></div>
                                <span class="theme-label">Branco</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Export Tab -->
                <div class="tab-panel" id="export-panel">
                    <div class="mobile-section">
                        <h4 class="section-title">Salvar & Carregar</h4>
                        <div class="mobile-button-grid">
                            <button class="mobile-btn secondary" onclick="exportAsJSON()">
                                <span class="btn-icon">üíæ</span>
                                <span class="btn-text">Salvar Projeto</span>
                            </button>
                            <button class="mobile-btn secondary" onclick="importJSON()">
                                <span class="btn-icon">üìÅ</span>
                                <span class="btn-text">Carregar Projeto</span>
                            </button>
                        </div>
                    </div>

                    <div class="mobile-section">
                        <h4 class="section-title">Exportar Imagem</h4>
                        <div class="mobile-button-grid">
                            <button class="mobile-btn secondary" onclick="exportAsPNG()">
                                <span class="btn-icon">üì∏</span>
                                <span class="btn-text">Exportar PNG</span>
                            </button>
                        </div>
                    </div>

                    <div class="mobile-section">
                        <h4 class="section-title">Estat√≠sticas</h4>
                        <div class="mobile-stats-detailed">
                            <div class="stat-item-mobile">
                                <span class="stat-icon">üîµ</span>
                                <span class="stat-label">N√≥s:</span>
                                <span class="stat-value" id="mobileNodeCount">0</span>
                            </div>
                            <div class="stat-item-mobile">
                                <span class="stat-icon">üîó</span>
                                <span class="stat-label">Conex√µes:</span>
                                <span class="stat-value" id="mobileConnectionCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Footer -->
            <div class="mobile-footer">
                <div class="signature-mobile">
                    <span class="signature-text">S(i)S ‚Ä¢ Morphyro</span>
                </div>
            </div>
        </div>
       
        <div class="canvas-container">
            <div class="floating-toolbar">
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">‚Ü∫</button>
                </div>
            </div>
           
            <div class="canvas" id="canvas">
                <svg id="connections" style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1;">
                </svg>
                
                <!-- Dica amig√°vel ap√≥s primeira limpeza -->
                <div id="friendlyTip" class="friendly-tip" style="display: none;">
                    <div class="friendly-tip-content">
                        <div class="friendly-tip-icon">üí°</div>
                        <h3>Dica √ötil!</h3>
                        <p>Clique com o <strong>bot√£o direito do mouse</strong> em qualquer lugar do canvas para abrir o seletor de formatos e criar novos n√≥s facilmente!</p>
                        <button class="friendly-tip-close" onclick="hideFriendlyTip()">Entendi! ‚ú®</button>
                    </div>
                </div>

                <!-- Confirma√ß√£o de limpeza -->
                <div id="clearConfirm" class="clear-confirm" style="display: none;">
                    <div class="clear-confirm-content">
                        <div class="clear-confirm-icon">‚ö†Ô∏è</div>
                        <h3>Limpar Mapa Mental</h3>
                        <p>Tem certeza que deseja <strong>limpar todo o mapa mental</strong>? Esta a√ß√£o n√£o pode ser desfeita.</p>
                        <div class="clear-confirm-buttons">
                            <button class="clear-confirm-cancel" onclick="hideClearConfirm()">Cancelar</button>
                            <button class="clear-confirm-ok" onclick="confirmClearCanvas()">Limpar Tudo</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Shape Selector Modal -->
            <div class="shape-selector" id="shapeSelector">
                <h3>Escolha o formato</h3>
                <div class="shape-selector-grid">
                    <div class="shape-selector-option" data-shape="rectangle">
                        <div class="shape-selector-preview rectangle"></div>
                        <div class="shape-selector-label">Retangular</div>
                    </div>
                    <div class="shape-selector-option" data-shape="square">
                        <div class="shape-selector-preview square"></div>
                        <div class="shape-selector-label">Quadrado</div>
                    </div>
                    <div class="shape-selector-option" data-shape="circle">
                        <div class="shape-selector-preview circle"></div>
                        <div class="shape-selector-label">Circular</div>
                    </div>
                    <div class="shape-selector-option" data-shape="ellipse">
                        <div class="shape-selector-preview ellipse"></div>
                        <div class="shape-selector-label">Elipse</div>
                    </div>
                </div>
            </div>
            
            <!-- Disconnect Menu -->
            <div class="disconnect-menu" id="disconnectMenu">
                <h4>Remover Liga√ß√µes</h4>
                <div id="disconnectOptions"></div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">

    <script>
        class MindMapApp {
            constructor() {
                this.nodes = [];
                this.connections = [];
                this.selectedNode = null;
                this.draggedNode = null;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.currentColor = '#ffffff';
                this.currentShape = 'rectangle';
                this.zoomLevel = 1;
                this.panOffset = { x: 220, y: 450 };
                this.nextNodeId = 1;
                this.connectingMode = false;
                this.sourceNode = null;
                this.shapeSelectorVisible = false;
                this.selectedShapeForNewNode = 'rectangle';
                this.shapeSelectorClickPosition = { x: 0, y: 0 };
                this.disconnectMenuVisible = false;
                this.currentNodeConnections = [];
                this.resizeMode = false;
                this.resizingNode = null;
                this.isResizing = false;
                this.resizeStartX = 0;
                this.resizeStartY = 0;
                this.initialNodeWidth = 0;
                this.initialNodeHeight = 0;
                this.customColor = '#667eea';
                this.recentColors = [];
                this.currentTheme = 'default';
                this.controlsMenuVisible = false;
                this.activeControlsMenu = null;
                this.mobileToolkitCollapsed = false;
                this.hasClearedOnce = false;
                this.isLandscape = false;
                
                // Rastreamento da posi√ß√£o do mouse para zoom
                this.mousePosition = { x: 0, y: 0 };
                
                // Sistema de drag and drop melhorado
                this.isPanning = false;
                this.panStartX = 0;
                this.panStartY = 0;
                this.initialPanOffsetX = 0;
                this.initialPanOffsetY = 0;
                this.isNodeDragging = false;
                this.nodeDragStartX = 0;
                this.nodeDragStartY = 0;
                this.nodeInitialX = 0;
                this.nodeInitialY = 0;
                
                // Suporte para pinch-to-zoom
                this.lastTouchDistance = 0;
                this.isPinching = false;
               
                this.init();
            }
           
            init() {
                this.setupEventListeners();
                this.setupShapeSelector();
                this.addInitialNode();
                this.updateStats();
                this.updateRecentColorsDisplay();
                this.loadTheme();
                this.detectMobileDevice();
                this.updateClearButtonEffect();
                
                // Garantir que o canvas tenha tamanho adequado na inicializa√ß√£o
                setTimeout(() => {
                    this.updateCanvasTransform();
                }, 100);
            }
            
            detectMobileDevice() {
                // Detectar se √© dispositivo m√≥vel
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                               window.innerWidth <= 768;
                
                if (this.isMobile) {
                    // Ajustar comportamentos para mobile
                    document.body.classList.add('mobile-device');
                    
                    // Detectar orienta√ß√£o inicial
                    this.detectOrientation();
                    
                    // Adicionar listener para mudan√ßas de orienta√ß√£o
                    window.addEventListener('orientationchange', () => {
                        setTimeout(() => {
                            this.detectOrientation();
                        }, 100);
                    });
                    
                    // Adicionar listener para mudan√ßas de tamanho da janela
                    window.addEventListener('resize', () => {
                        this.detectOrientation();
                    });
                    
                    // Desabilitar hover effects em mobile
                    const style = document.createElement('style');
                    style.textContent = `
                        @media (hover: none) and (pointer: coarse) {
                            .node:hover {
                                transform: none !important;
                                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
                            }
                            
                            .btn:hover {
                                transform: none !important;
                                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
                            }
                            
                            .control-btn:hover {
                                transform: none !important;
                            }
                            
                            .shape-option:hover {
                                transform: none !important;
                            }
                            
                            .color-option:hover {
                                transform: none !important;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            detectOrientation() {
                const mobileToolkit = document.getElementById('mobileToolkit');
                if (!mobileToolkit) return;

                // Detectar se √© landscape
                this.isLandscape = window.innerWidth > window.innerHeight && window.innerWidth <= 768;
                
                if (this.isLandscape) {
                    mobileToolkit.classList.add('landscape');
                    mobileToolkit.classList.remove('portrait');
                } else {
                    mobileToolkit.classList.add('portrait');
                    mobileToolkit.classList.remove('landscape');
                }
            }

            toggleMobileToolkit() {
                const mobileToolkit = document.getElementById('mobileToolkit');
                if (!mobileToolkit) return;

                this.mobileToolkitCollapsed = !this.mobileToolkitCollapsed;
                
                if (this.mobileToolkitCollapsed) {
                    mobileToolkit.classList.add('collapsed');
                } else {
                    mobileToolkit.classList.remove('collapsed');
                }

                // Feedback t√°til
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }

                // Ajustar canvas container
                this.adjustCanvasForToolkit();
            }

            adjustCanvasForToolkit() {
                const canvasContainer = document.querySelector('.canvas-container');
                if (!canvasContainer) return;

                if (this.isLandscape) {
                    if (this.mobileToolkitCollapsed) {
                        canvasContainer.style.marginLeft = '40px';
                        canvasContainer.style.width = 'calc(100vw - 40px)';
                    } else {
                        canvasContainer.style.marginLeft = '35vw';
                        canvasContainer.style.width = '65vw';
                    }
                } else {
                    if (this.mobileToolkitCollapsed) {
                        canvasContainer.style.height = 'calc(100vh - 40px)';
                    } else {
                        canvasContainer.style.height = '60vh';
                    }
                }
            }
           
            setupEventListeners() {
                const canvas = document.getElementById('canvas');
                const canvasContainer = document.querySelector('.canvas-container');
               
                // Eventos de mouse para o canvas container (√°rea expandida)
                canvasContainer.addEventListener('mousedown', this.handleMouseDown.bind(this));
                canvasContainer.addEventListener('mousemove', this.handleMouseMove.bind(this));
                canvasContainer.addEventListener('mouseup', this.handleMouseUp.bind(this));
                canvasContainer.addEventListener('dblclick', this.handleDoubleClick.bind(this));
                canvasContainer.addEventListener('wheel', this.handleWheel.bind(this));
                
                // Rastrear posi√ß√£o do mouse para zoom
                canvasContainer.addEventListener('mousemove', (e) => {
                    const rect = canvasContainer.getBoundingClientRect();
                    this.mousePosition.x = e.clientX - rect.left;
                    this.mousePosition.y = e.clientY - rect.top;
                });
                
                // Eventos de touch para dispositivos m√≥veis
                canvasContainer.addEventListener('touchstart', this.handleTouchStart.bind(this));
                canvasContainer.addEventListener('touchmove', this.handleTouchMove.bind(this));
                canvasContainer.addEventListener('touchend', this.handleTouchEnd.bind(this));
                
                // Suporte para toque duplo em mobile
                let lastTouchTime = 0;
                canvasContainer.addEventListener('touchend', (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTouchTime;
                    if (tapLength < 500 && tapLength > 0) {
                        // Toque duplo detectado
                        const touch = e.changedTouches[0];
                        const node = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.node');
                        if (node) {
                            const nodeData = this.nodes.find(n => n.element === node);
                            this.editNode(nodeData);
                        }
                    }
                    lastTouchTime = currentTime;
                });
               
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
                document.addEventListener('paste', this.handlePaste.bind(this));
               
                // Fechar seletor ao clicar fora
                document.addEventListener('click', (e) => {
                    if (this.shapeSelectorVisible && !e.target.closest('.shape-selector')) {
                        this.hideShapeSelector();
                    }
                    if (this.disconnectMenuVisible && !e.target.closest('.disconnect-menu') && !e.target.closest('.control-btn.disconnect')) {
                        this.hideDisconnectMenu();
                    }
                    if (this.controlsMenuVisible && !e.target.closest('.node-controls')) {
                        this.hideControlsMenu();
                    }
                });
               
                // Menu de contexto personalizado
                canvasContainer.addEventListener('contextmenu', this.handleRightClick.bind(this));
            }

            setupShapeSelector() {
                const shapeSelector = document.getElementById('shapeSelector');
                const shapeOptions = shapeSelector.querySelectorAll('.shape-selector-option');

                // Criar n√≥ automaticamente ao clicar na forma
                shapeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectedShapeForNewNode = option.dataset.shape;
                        this.createNodeWithSelectedShape();
                        this.hideShapeSelector();
                    });
                });

                // Fechar ao clicar fora
                shapeSelector.addEventListener('click', (e) => {
                    if (e.target === shapeSelector) {
                        this.hideShapeSelector();
                    }
                });
            }

            showShapeSelector(x, y) {
                const shapeSelector = document.getElementById('shapeSelector');
                const canvasContainer = document.querySelector('.canvas-container');
                const containerRect = canvasContainer.getBoundingClientRect();
                
                // Armazenar a posi√ß√£o original do clique para criar o n√≥
                const originalClickX = x - containerRect.left;
                const originalClickY = y - containerRect.top;
                this.shapeSelectorClickPosition = { x: originalClickX, y: originalClickY };
                
                // Posicionar o seletor pr√≥ximo ao clique
                const selectorWidth = 280;
                const selectorHeight = 180;
                
                let posX = originalClickX;
                let posY = originalClickY;
                
                // Ajustar posi√ß√£o se sair da tela
                if (posX + selectorWidth > containerRect.width) {
                    posX = containerRect.width - selectorWidth - 20;
                }
                if (posY + selectorHeight > containerRect.height) {
                    posY = containerRect.height - selectorHeight - 20;
                }
                if (posX < 20) posX = 20;
                if (posY < 20) posY = 20;
                
                shapeSelector.style.left = posX + 'px';
                shapeSelector.style.top = posY + 'px';
                shapeSelector.classList.add('show');
                this.shapeSelectorVisible = true;
            }

            hideShapeSelector() {
                const shapeSelector = document.getElementById('shapeSelector');
                shapeSelector.classList.remove('show');
                this.shapeSelectorVisible = false;
            }

            createNodeWithSelectedShape() {
                // Temporariamente alterar a forma atual
                const originalShape = this.currentShape;
                this.currentShape = this.selectedShapeForNewNode;
                
                // As coordenadas j√° est√£o corretas - s√£o relativas ao container do canvas
                // N√£o precisamos converter, apenas usar diretamente
                const canvasX = this.shapeSelectorClickPosition.x;
                const canvasY = this.shapeSelectorClickPosition.y;
                
                console.log('Posi√ß√£o do clique:', this.shapeSelectorClickPosition);
                console.log('Criando n√≥ em:', { x: canvasX, y: canvasY });
                
                // Criar n√≥ na posi√ß√£o correta do canvas
                this.addNode(
                    canvasX,
                    canvasY,
                    'Nova Ideia'
                );
                
                // Restaurar forma original
                this.currentShape = originalShape;
            }

            showDisconnectMenu(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (!node) return;

                // Encontrar todas as conex√µes deste n√≥
                const connections = this.connections.filter(conn => 
                    conn.from.id === nodeId || conn.to.id === nodeId
                );

                if (connections.length === 0) {
                    alert('Este n√≥ n√£o possui liga√ß√µes para remover.');
                    return;
                }

                const disconnectMenu = document.getElementById('disconnectMenu');
                const disconnectOptions = document.getElementById('disconnectOptions');
                
                // Limpar op√ß√µes anteriores
                disconnectOptions.innerHTML = '';

                // Armazenar as conex√µes para refer√™ncia
                this.currentNodeConnections = connections;

                // Adicionar op√ß√£o para cada conex√£o
                connections.forEach((conn, index) => {
                    const otherNode = conn.from.id === nodeId ? conn.to : conn.from;
                    const option = document.createElement('div');
                    option.className = 'disconnect-option';
                    option.innerHTML = `
                        <div class="disconnect-option-text" id="connection-text-${index}">${otherNode.text}</div>
                        <button class="disconnect-option-btn" onclick="app.removeConnectionByIndex(${index})">Remover</button>
                    `;
                    disconnectOptions.appendChild(option);
                });

                // Posicionar o menu pr√≥ximo ao n√≥
                const nodeRect = node.element.getBoundingClientRect();
                const canvasContainer = document.querySelector('.canvas-container');
                const containerRect = canvasContainer.getBoundingClientRect();
                
                let posX = nodeRect.right - containerRect.left + 10;
                let posY = nodeRect.top - containerRect.top;

                // Ajustar posi√ß√£o se sair da tela
                const menuWidth = 200;
                const menuHeight = Math.min(200, connections.length * 40 + 60);
                
                if (posX + menuWidth > containerRect.width) {
                    posX = nodeRect.left - containerRect.left - menuWidth - 10;
                }
                if (posY + menuHeight > containerRect.height) {
                    posY = containerRect.height - menuHeight - 20;
                }
                if (posX < 20) posX = 20;
                if (posY < 20) posY = 20;

                disconnectMenu.style.left = posX + 'px';
                disconnectMenu.style.top = posY + 'px';
                disconnectMenu.classList.add('show');
                this.disconnectMenuVisible = true;
            }

            hideDisconnectMenu() {
                const disconnectMenu = document.getElementById('disconnectMenu');
                disconnectMenu.classList.remove('show');
                this.disconnectMenuVisible = false;
            }

            updateDisconnectMenuText() {
                if (!this.disconnectMenuVisible || !this.currentNodeConnections) return;

                this.currentNodeConnections.forEach((conn, index) => {
                    const textElement = document.getElementById(`connection-text-${index}`);
                    if (textElement) {
                        // Encontrar o n√≥ atual (o que est√° selecionado)
                        const currentNode = this.selectedNode;
                        if (currentNode) {
                            const otherNode = conn.from.id === currentNode.id ? conn.to : conn.from;
                            textElement.textContent = otherNode.text;
                        }
                    }
                });
            }

            updateAllDisconnectMenus() {
                // Atualizar todos os menus de desconex√£o abertos
                if (this.disconnectMenuVisible) {
                    this.updateDisconnectMenuText();
                }
                
                // Atualizar tamb√©m os bot√µes de desconex√£o em todos os n√≥s
                this.updateNodeControls();
            }

            removeConnectionByIndex(connectionIndex) {
                if (!this.currentNodeConnections || connectionIndex < 0 || connectionIndex >= this.currentNodeConnections.length) {
                    console.error('√çndice de conex√£o inv√°lido');
                    return;
                }

                const connectionToRemove = this.currentNodeConnections[connectionIndex];
                
                // Encontrar o √≠ndice real no array principal
                const realIndex = this.connections.findIndex(conn => 
                    (conn.from.id === connectionToRemove.from.id && conn.to.id === connectionToRemove.to.id) ||
                    (conn.from.id === connectionToRemove.to.id && conn.to.id === connectionToRemove.from.id)
                );

                if (realIndex !== -1) {
                    this.connections.splice(realIndex, 1);
                    this.updateConnections();
                    this.updateStats();
                    this.updateNodeControls();
                    this.hideDisconnectMenu();
                    
                    // Mostrar mensagem de sucesso
                    console.log('Conex√£o removida com sucesso!');
                } else {
                    console.error('N√£o foi poss√≠vel encontrar a conex√£o para remover');
                }
            }

            toggleResizeMode(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (!node) return;

                if (this.resizeMode && this.resizingNode) {
                    if (this.resizingNode.id === nodeId) {
                        this.resizeMode = false;
                        this.resizingNode = null;
                        node.element.classList.remove('resize-mode');
                    } else {
                        // Trocar para outro n√≥
                        this.resizingNode.element.classList.remove('resize-mode');
                        this.resizeMode = true;
                        this.resizingNode = node;
                        node.element.classList.add('resize-mode');
                    }
                } else {
                    this.resizeMode = true;
                    this.resizingNode = node;
                    node.element.classList.add('resize-mode');
                }
                
                // Log para debug
                console.log('Modo resize ativado para n√≥:', nodeId, 'Forma:', node.shape);
                console.log('Tamanho atual:', node.element.offsetWidth + 'x' + node.element.offsetHeight);
            }
           
            addInitialNode() {
                // Criar mapa mental de exemplo
                const centerX =780; 
                const centerY = 450; 
                
                // N√≥ central - cor dourada para destaque
                const centralNode = this.addNode(centerX, centerY, 'Meu Projeto', null, true);
                this.setNodeColorById(centralNode.id, '#FFD700'); // Dourado
                
                // N√≥s principais (primeiro n√≠vel) - cores por categoria
                const node1 = this.addNode(centerX - 200, centerY - 100, 'Planejamento', null, true);
                this.setNodeColorById(node1.id, '#4CAF50'); // Verde para planejamento
                
                const node2 = this.addNode(centerX + 140, centerY - 100, 'Desenvolvimento', null, true);
                this.setNodeColorById(node2.id, '#2196F3'); // Azul para desenvolvimento
                
                const node3 = this.addNode(centerX - 200, centerY + 100, 'Recursos', null, true);
                this.setNodeColorById(node3.id, '#FF9800'); // Laranja para recursos
                
                const node4 = this.addNode(centerX + 200, centerY + 100, 'Testes', null, true);
                this.setNodeColorById(node4.id, '#9C27B0'); // Roxo para testes
                
                // N√≥s secund√°rios (segundo n√≠vel) - tons mais claros da mesma cor
                const node1a = this.addNode(centerX - 350, centerY - 200, 'Cronograma', null, true);
                this.setNodeColorById(node1a.id, '#81C784'); // Verde claro
                
                const node1b = this.addNode(centerX - 350, centerY - 50, 'Objetivos', null, true);
                this.setNodeColorById(node1b.id, '#A5D6A7'); // Verde mais claro
                
                const node2a = this.addNode(centerX + 350, centerY - 200, 'Frontend', null, true);
                this.setNodeColorById(node2a.id, '#64B5F6'); // Azul claro
                
                const node2b = this.addNode(centerX + 350, centerY - 50, 'Backend', null, true);
                this.setNodeColorById(node2b.id, '#90CAF9'); // Azul mais claro
                
                const node3a = this.addNode(centerX - 350, centerY + 50, 'Equipe', null, true);
                this.setNodeColorById(node3a.id, '#FFB74D'); // Laranja claro
                
                const node3b = this.addNode(centerX - 350, centerY + 200, 'Or√ßamento', null, true);
                this.setNodeColorById(node3b.id, '#FFCC80'); // Laranja mais claro
                
                const node4a = this.addNode(centerX + 350, centerY + 50, 'QA', null, true);
                this.setNodeColorById(node4a.id, '#BA68C8'); // Roxo claro
                
                const node4b = this.addNode(centerX + 350, centerY + 200, 'Deploy', null, true);
                this.setNodeColorById(node4b.id, '#CE93D8'); // Roxo mais claro
                
                // Conectar n√≥s central aos principais
                this.connectNodes(centralNode.id, node1.id);
                this.connectNodes(centralNode.id, node2.id);
                this.connectNodes(centralNode.id, node3.id);
                this.connectNodes(centralNode.id, node4.id);
                
                // Conectar n√≥s principais aos secund√°rios
                this.connectNodes(node1.id, node1a.id);
                this.connectNodes(node1.id, node1b.id);
                this.connectNodes(node2.id, node2a.id);
                this.connectNodes(node2.id, node2b.id);
                this.connectNodes(node3.id, node3a.id);
                this.connectNodes(node3.id, node3b.id);
                this.connectNodes(node4.id, node4a.id);
                this.connectNodes(node4.id, node4b.id);
            }
           
            addNode(x = null, y = null, text = 'Nova Ideia', mediaData = null, isExample = false) {
                const canvasContainer = document.querySelector('.canvas-container');
                const rect = canvasContainer.getBoundingClientRect();
               
                if (x === null) x = (rect.width / 2) + Math.random() * 200 - 100;
                if (y === null) y = (rect.height / 2) + Math.random() * 200 - 100;
               
                const node = {
                    id: this.nextNodeId++,
                    x: x,
                    y: y,
                    text: text,
                    color: this.currentColor,
                    shape: this.currentShape,
                    mediaData: mediaData,
                    element: null,
                    isExample: isExample
                };
               
                this.nodes.push(node);
                this.createNodeElement(node);
                this.updateStats();
                return node;
            }
           
            createNodeElement(node) {
                const nodeEl = document.createElement('div');
                nodeEl.className = `node node-appear node-shape-${node.shape}`;
                nodeEl.style.left = node.x + 'px';
                nodeEl.style.top = node.y + 'px';
                nodeEl.style.backgroundColor = node.color;
                
                let content = '';
                if (node.mediaData) {
                    if (node.mediaData.type === 'image') {
                        content = `<img src="${node.mediaData.data}" style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 5px;" alt="Imagem">`;
                    } else if (node.mediaData.type === 'video') {
                        content = `<video src="${node.mediaData.data}" style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 5px;" controls></video>`;
                    }
                }
                
                if (node.text) {
                    content += node.text;
                }
                
                nodeEl.innerHTML = `
                    <div class="node-content">${content}</div>
                    <div class="node-controls">
                        <button class="control-btn settings" onclick="app.toggleControlsExpansion(${node.id})" title="Configura√ß√µes">‚öôÔ∏è</button>
                        <div class="node-controls-expanded" id="controls-expanded-${node.id}">
                            <button class="control-btn connect" onclick="app.toggleConnectMode(${node.id})" title="Conectar">üîó</button>
                            <button class="control-btn disconnect" onclick="app.showDisconnectMenu(${node.id})" title="Remover Liga√ß√µes" style="display: none;">‚úÇÔ∏è</button>
                            <button class="control-btn resize" onclick="app.toggleResizeMode(${node.id})" title="Redimensionar">üìè</button>
                            <button class="control-btn delete" onclick="app.deleteNode(${node.id})" title="Deletar">√ó</button>
                        </div>
                    </div>
                `;
               
                node.element = nodeEl;
                document.getElementById('canvas').appendChild(nodeEl);
                
                // Ajustar tamanho do texto ap√≥s criar o elemento
                setTimeout(() => {
                    this.adjustNodeTextSize(node);
                }, 100);
            }
           
            handleMouseDown(e) {
                if (e.button !== 0) return; // Apenas bot√£o esquerdo do mouse
                
                const node = e.target.closest('.node');
               
                if (node) {
                    const nodeData = this.nodes.find(n => n.element === node);
                   
                    if (this.connectingMode && this.sourceNode && nodeData.id !== this.sourceNode.id) {
                        this.createConnection(this.sourceNode, nodeData);
                        this.connectingMode = false;
                        this.sourceNode = null;
                        return;
                    }

                    if (this.resizeMode && this.resizingNode && nodeData.id === this.resizingNode.id) {
                        this.isResizing = true;
                        this.resizeStartX = e.clientX;
                        this.resizeStartY = e.clientY;
                        const rect = node.getBoundingClientRect();
                        this.initialNodeWidth = rect.width;
                        this.initialNodeHeight = rect.height;
                        node.classList.add('resizing');
                        
                        // Para c√≠rculo, elipse e quadrado, remover as restri√ß√µes de tamanho durante redimensionamento
                        if (nodeData.shape === 'circle') {
                            node.style.minWidth = '60px';
                            node.style.minHeight = '60px';
                            node.style.maxWidth = '200px';
                            node.style.maxHeight = '200px';
                        } else if (nodeData.shape === 'ellipse') {
                            node.style.minWidth = '80px';
                            node.style.minHeight = '50px';
                            node.style.maxWidth = '300px';
                            node.style.maxHeight = '200px';
                        } else if (nodeData.shape === 'square') {
                            node.style.minWidth = '60px';
                            node.style.minHeight = '60px';
                            node.style.maxWidth = '200px';
                            node.style.maxHeight = '200px';
                        }
                        return;
                    }
                   
                    this.selectNode(nodeData);
                    this.isNodeDragging = true;
                    this.nodeDragStartX = e.clientX;
                    this.nodeDragStartY = e.clientY;
                    this.nodeInitialX = nodeData.x;
                    this.nodeInitialY = nodeData.y;
                   
                    // Adicionar classe de drag para feedback visual
                    node.classList.add('dragging');
                } else {
                    this.deselectAll();
                    
                    // Sair do modo de redimensionamento se estiver ativo
                    if (this.resizeMode) {
                        this.resizeMode = false;
                        if (this.resizingNode) {
                            this.resizingNode.element.classList.remove('resize-mode');
                            this.resizingNode = null;
                        }
                    }
                    
                    // Iniciar pan do canvas
                    this.isPanning = true;
                    this.panStartX = e.clientX;
                    this.panStartY = e.clientY;
                    this.initialPanOffsetX = this.panOffset.x;
                    this.initialPanOffsetY = this.panOffset.y;
                    
                    // Adicionar classe de panning
                    const canvas = document.getElementById('canvas');
                    canvas.classList.add('panning');
                   
                    if (e.shiftKey) {
                        const canvasContainer = document.querySelector('.canvas-container');
                        const rect = canvasContainer.getBoundingClientRect();
                        this.addNode(e.clientX - rect.left, e.clientY - rect.top);
                    }
                }
               
                e.preventDefault();
            }
           
            handleMouseMove(e) {
                if (this.isResizing && this.resizingNode) {
                    const dx = e.clientX - this.resizeStartX;
                    const dy = e.clientY - this.resizeStartY;
                    
                    if (this.resizingNode.shape === 'circle') {
                        // Para c√≠rculo, usar a m√©dia de dx e dy para manter formato circular
                        const avgDelta = (dx + dy) / 2;
                        const newSize = Math.max(60, Math.min(200, this.initialNodeWidth + avgDelta));
                        
                        // Aplicar o novo tamanho
                        this.resizingNode.element.style.width = newSize + 'px';
                        this.resizingNode.element.style.height = newSize + 'px';
                        
                        // For√ßar o border-radius para manter formato circular
                        this.resizingNode.element.style.borderRadius = '50%';
                        
                        // Ajustar tamanho do texto
                        this.adjustNodeTextSize(this.resizingNode);
                        
                        console.log('Redimensionando c√≠rculo para:', newSize + 'px');
                    } else if (this.resizingNode.shape === 'ellipse') {
                        // Para elipse, redimensionar normalmente mantendo propor√ß√£o
                        const newWidth = Math.max(80, this.initialNodeWidth + dx);
                        const newHeight = Math.max(50, this.initialNodeHeight + dy);
                        
                        // For√ßar as dimens√µes
                        this.resizingNode.element.style.width = newWidth + 'px';
                        this.resizingNode.element.style.height = newHeight + 'px';
                        this.resizingNode.element.style.minWidth = newWidth + 'px';
                        this.resizingNode.element.style.minHeight = newHeight + 'px';
                        this.resizingNode.element.style.maxWidth = newWidth + 'px';
                        this.resizingNode.element.style.maxHeight = newHeight + 'px';
                        
                        // Manter formato el√≠ptico
                        this.resizingNode.element.style.borderRadius = '50%';
                        
                        // Ajustar tamanho do texto
                        this.adjustNodeTextSize(this.resizingNode);
                        
                        console.log('Redimensionando elipse para:', newWidth + 'x' + newHeight + 'px');
                    } else if (this.resizingNode.shape === 'square') {
                        // Para quadrado, usar a m√©dia de dx e dy para manter formato quadrado
                        const avgDelta = (dx + dy) / 2;
                        const newSize = Math.max(60, Math.min(200, this.initialNodeWidth + avgDelta));
                        
                        // For√ßar as dimens√µes
                        this.resizingNode.element.style.width = newSize + 'px';
                        this.resizingNode.element.style.height = newSize + 'px';
                        this.resizingNode.element.style.minWidth = newSize + 'px';
                        this.resizingNode.element.style.minHeight = newSize + 'px';
                        this.resizingNode.element.style.maxWidth = newSize + 'px';
                        this.resizingNode.element.style.maxHeight = newSize + 'px';
                        
                        // Manter formato quadrado
                        this.resizingNode.element.style.borderRadius = '8px';
                        
                        // Ajustar tamanho do texto
                        this.adjustNodeTextSize(this.resizingNode);
                        
                        console.log('Redimensionando quadrado para:', newSize + 'x' + newSize + 'px');
                    } else {
                        // Para outras formas, comportamento normal
                        const newWidth = Math.max(80, this.initialNodeWidth + dx);
                        const newHeight = Math.max(40, this.initialNodeHeight + dy);
                        
                        this.resizingNode.element.style.width = newWidth + 'px';
                        this.resizingNode.element.style.height = newHeight + 'px';
                        
                        // Ajustar tamanho do texto
                        this.adjustNodeTextSize(this.resizingNode);
                    }
                    
                    this.updateConnections();
                } else if (this.isNodeDragging && this.selectedNode) {
                    const dx = e.clientX - this.nodeDragStartX;
                    const dy = e.clientY - this.nodeDragStartY;
                    
                    this.selectedNode.x = this.nodeInitialX + dx / this.zoomLevel;
                    this.selectedNode.y = this.nodeInitialY + dy / this.zoomLevel;
                    
                    this.updateNodePosition(this.selectedNode);
                    this.updateConnections();
                } else if (this.isPanning) {
                    const dx = e.clientX - this.panStartX;
                    const dy = e.clientY - this.panStartY;
                    
                    this.panOffset.x = this.initialPanOffsetX + dx;
                    this.panOffset.y = this.initialPanOffsetY + dy;
                    
                    this.updateCanvasTransform();
                }
            }
           
            handleMouseUp(e) {
                if (this.isResizing && this.resizingNode) {
                    this.resizingNode.element.classList.remove('resizing');
                    
                    // Salvar o tamanho final do c√≠rculo ou elipse
                    if (this.resizingNode.shape === 'circle') {
                        const finalSize = this.resizingNode.element.offsetWidth;
                        this.resizingNode.element.style.width = finalSize + 'px';
                        this.resizingNode.element.style.height = finalSize + 'px';
                        this.resizingNode.element.style.minWidth = finalSize + 'px';
                        this.resizingNode.element.style.minHeight = finalSize + 'px';
                        this.resizingNode.element.style.maxWidth = finalSize + 'px';
                        this.resizingNode.element.style.maxHeight = finalSize + 'px';
                        this.resizingNode.element.style.borderRadius = '50%';
                        
                        console.log('Tamanho final do c√≠rculo:', finalSize + 'px');
                    } else if (this.resizingNode.shape === 'ellipse') {
                        const finalWidth = this.resizingNode.element.offsetWidth;
                        const finalHeight = this.resizingNode.element.offsetHeight;
                        this.resizingNode.element.style.width = finalWidth + 'px';
                        this.resizingNode.element.style.height = finalHeight + 'px';
                        this.resizingNode.element.style.minWidth = finalWidth + 'px';
                        this.resizingNode.element.style.minHeight = finalHeight + 'px';
                        this.resizingNode.element.style.maxWidth = finalWidth + 'px';
                        this.resizingNode.element.style.maxHeight = finalHeight + 'px';
                        this.resizingNode.element.style.borderRadius = '50%';
                        
                        console.log('Tamanho final da elipse:', finalWidth + 'x' + finalHeight + 'px');
                    } else if (this.resizingNode.shape === 'square') {
                        const finalSize = this.resizingNode.element.offsetWidth;
                        this.resizingNode.element.style.width = finalSize + 'px';
                        this.resizingNode.element.style.height = finalSize + 'px';
                        this.resizingNode.element.style.minWidth = finalSize + 'px';
                        this.resizingNode.element.style.minHeight = finalSize + 'px';
                        this.resizingNode.element.style.maxWidth = finalSize + 'px';
                        this.resizingNode.element.style.maxHeight = finalSize + 'px';
                        this.resizingNode.element.style.borderRadius = '8px';
                        
                        console.log('Tamanho final do quadrado:', finalSize + 'x' + finalSize + 'px');
                    }
                    
                    this.isResizing = false;
                } else if (this.selectedNode && this.isNodeDragging) {
                    this.selectedNode.element.classList.remove('dragging');
                }
                this.isNodeDragging = false;
                this.isPanning = false;
                
                // Remover classe de panning
                const canvas = document.getElementById('canvas');
                canvas.classList.remove('panning');
            }
            
            handleTouchStart(e) {
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const node = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.node');
               
                if (node) {
                    const nodeData = this.nodes.find(n => n.element === node);
                   
                    if (this.connectingMode && this.sourceNode && nodeData.id !== this.sourceNode.id) {
                        this.createConnection(this.sourceNode, nodeData);
                        this.connectingMode = false;
                        this.sourceNode = null;
                        return;
                    }
                   
                    this.selectNode(nodeData);
                    this.isNodeDragging = true;
                    this.nodeDragStartX = touch.clientX;
                    this.nodeDragStartY = touch.clientY;
                    this.nodeInitialX = nodeData.x;
                    this.nodeInitialY = nodeData.y;
                   
                    node.classList.add('dragging');
                    
                    // Feedback t√°til para mobile
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                } else {
                    this.deselectAll();
                    
                    // Sair do modo de redimensionamento se estiver ativo
                    if (this.resizeMode) {
                        this.resizeMode = false;
                        if (this.resizingNode) {
                            this.resizingNode.element.classList.remove('resize-mode');
                            this.resizingNode = null;
                        }
                    }
                    
                    this.isPanning = true;
                    this.panStartX = touch.clientX;
                    this.panStartY = touch.clientY;
                    this.initialPanOffsetX = this.panOffset.x;
                    this.initialPanOffsetY = this.panOffset.y;
                    
                    // Adicionar classe de panning
                    const canvas = document.getElementById('canvas');
                    canvas.classList.add('panning');
                }
               
                e.preventDefault();
            }
            
            handleTouchMove(e) {
                // Suporte para pinch-to-zoom
                if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const distance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) + 
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    
                    if (this.lastTouchDistance > 0) {
                        const scale = distance / this.lastTouchDistance;
                        const newZoom = this.zoomLevel * scale;
                        this.zoomLevel = Math.max(0.1, Math.min(3, newZoom));
                        this.updateZoom();
                    }
                    
                    this.lastTouchDistance = distance;
                    this.isPinching = true;
                    e.preventDefault();
                    return;
                }
                
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                
                if (this.isNodeDragging && this.selectedNode && !this.isPinching) {
                    const dx = touch.clientX - this.nodeDragStartX;
                    const dy = touch.clientY - this.nodeDragStartY;
                    
                    this.selectedNode.x = this.nodeInitialX + dx / this.zoomLevel;
                    this.selectedNode.y = this.nodeInitialY + dy / this.zoomLevel;
                    
                    this.updateNodePosition(this.selectedNode);
                    this.updateConnections();
                } else if (this.isPanning && !this.isPinching) {
                    const dx = touch.clientX - this.panStartX;
                    const dy = touch.clientY - this.panStartY;
                    
                    this.panOffset.x = this.initialPanOffsetX + dx;
                    this.panOffset.y = this.initialPanOffsetY + dy;
                    
                    this.updateCanvasTransform();
                }
                
                e.preventDefault();
            }
            
            handleTouchEnd(e) {
                if (this.selectedNode && this.isNodeDragging) {
                    this.selectedNode.element.classList.remove('dragging');
                }
                this.isNodeDragging = false;
                this.isPanning = false;
                this.isPinching = false;
                this.lastTouchDistance = 0;
                
                // Remover classe de panning
                const canvas = document.getElementById('canvas');
                canvas.classList.remove('panning');
            }
           
            handleDoubleClick(e) {
                const node = e.target.closest('.node');
                if (node) {
                    const nodeData = this.nodes.find(n => n.element === node);
                    this.editNode(nodeData);
                }
            }
           
            handleWheel(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const oldZoom = this.zoomLevel;
                this.zoomLevel *= delta;
                this.zoomLevel = Math.max(0.1, Math.min(3, this.zoomLevel));
                
                // Ajustar pan offset para zoom no ponto do mouse
                const rect = e.target.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const zoomRatio = this.zoomLevel / oldZoom;
                this.panOffset.x = mouseX - (mouseX - this.panOffset.x) * zoomRatio;
                this.panOffset.y = mouseY - (mouseY - this.panOffset.y) * zoomRatio;
                
                this.updateZoom();
            }
           
            handleKeyDown(e) {
                if (e.key === 'Delete' && this.selectedNode) {
                    this.deleteNode(this.selectedNode.id);
                } else if (e.key === 'Escape') {
                    this.connectingMode = false;
                    this.sourceNode = null;
                    this.resizeMode = false;
                    this.resizingNode = null;
                    this.deselectAll();
                    this.hideShapeSelector();
                    this.hideDisconnectMenu();
                    this.hideControlsMenu();
                } else if (e.key === 'Enter' && this.selectedNode) {
                    this.editNode(this.selectedNode);
                }
            }

            handleRightClick(e) {
                e.preventDefault();
                
                // Verificar se clicou em um n√≥
                const node = e.target.closest('.node');
                if (node) {
                    // Se clicou em um n√≥, n√£o mostrar o seletor
                    return;
                }
                
                // Mostrar o seletor de formas na posi√ß√£o do clique
                this.showShapeSelector(e.clientX, e.clientY);
            }

            handlePaste(e) {
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const canvasContainer = document.querySelector('.canvas-container');
                            const rect = canvasContainer.getBoundingClientRect();
                            const x = rect.width / 2 + Math.random() * 200 - 100;
                            const y = rect.height / 2 + Math.random() * 200 - 100;
                            
                            this.addNode(x, y, '', {
                                type: 'image',
                                data: event.target.result
                            });
                        };
                        reader.readAsDataURL(file);
                        e.preventDefault();
                    } else if (item.type.indexOf('video') !== -1) {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const canvasContainer = document.querySelector('.canvas-container');
                            const rect = canvasContainer.getBoundingClientRect();
                            const x = rect.width / 2 + Math.random() * 200 - 100;
                            const y = rect.height / 2 + Math.random() * 200 - 100;
                            
                            this.addNode(x, y, 'V√≠deo Colado', {
                                type: 'video',
                                data: event.target.result
                            });
                        };
                        reader.readAsDataURL(file);
                        e.preventDefault();
                    }
                }
            }
           
            selectNode(node) {
                this.deselectAll();
                this.selectedNode = node;
                node.element.classList.add('selected');
            }
           
            deselectAll() {
                this.nodes.forEach(node => {
                    node.element.classList.remove('selected');
                });
                this.selectedNode = null;
                
                // Sair do modo de redimensionamento se estiver ativo
                if (this.resizeMode) {
                    this.resizeMode = false;
                    if (this.resizingNode) {
                        this.resizingNode.element.classList.remove('resize-mode');
                        this.resizingNode = null;
                    }
                }
            }
           
            editNode(node) {
                const originalText = node.text;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalText;
                input.className = 'node-edit';
               
                node.element.innerHTML = '';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'node-content';
                contentDiv.appendChild(input);
                node.element.appendChild(contentDiv);
                node.element.classList.add('editing');
               
                input.focus();
                input.select();
               
                const finishEdit = () => {
                    const newText = input.value || originalText;
                    node.text = newText;
                    node.element.classList.remove('editing');
                    node.element.innerHTML = `
                        <div class="node-content">${newText}</div>
                        <div class="node-controls">
                            <button class="control-btn settings" onclick="app.toggleControlsExpansion(${node.id})" title="Configura√ß√µes">‚öôÔ∏è</button>
                            <div class="node-controls-expanded" id="controls-expanded-${node.id}">
                                <button class="control-btn connect" onclick="app.toggleConnectMode(${node.id})" title="Conectar">üîó</button>
                                <button class="control-btn disconnect" onclick="app.showDisconnectMenu(${node.id})" title="Remover Liga√ß√µes" style="display: none;">‚úÇÔ∏è</button>
                                <button class="control-btn resize" onclick="app.toggleResizeMode(${node.id})" title="Redimensionar">üìè</button>
                                <button class="control-btn delete" onclick="app.deleteNode(${node.id})" title="Deletar">√ó</button>
                            </div>
                        </div>
                    `;
                    
                    // Atualizar menu de desconex√£o se estiver aberto
                    this.updateDisconnectMenuText();
                    
                    // Ajustar tamanho do texto ap√≥s edi√ß√£o
                    setTimeout(() => {
                        this.adjustNodeTextSize(node);
                    }, 100);
                    
                    // Deselecionar o n√≥ ap√≥s edi√ß√£o
                    this.deselectAll();
                    
                    // Remover o event listener de clique fora
                    document.removeEventListener('click', this.handleClickOutsideEdit);
                };
               
                // Fun√ß√£o para lidar com cliques fora do n√≥ em edi√ß√£o
                this.handleClickOutsideEdit = (e) => {
                    if (!node.element.contains(e.target)) {
                        finishEdit();
                    }
                };
               
                input.addEventListener('blur', finishEdit);
                input.addEventListener('input', () => {
                    // Atualizar texto em tempo real enquanto digita
                    node.text = input.value;
                    this.updateDisconnectMenuText();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    } else if (e.key === 'Escape') {
                        input.value = originalText;
                        input.blur();
                    }
                });
                
                // Adicionar event listener para cliques fora do n√≥
                setTimeout(() => {
                    document.addEventListener('click', this.handleClickOutsideEdit);
                }, 100);
            }
           
            deleteNode(nodeId) {
                const nodeIndex = this.nodes.findIndex(n => n.id === nodeId);
                if (nodeIndex === -1) return;
               
                const node = this.nodes[nodeIndex];
               
                // Remover conex√µes relacionadas
                this.connections = this.connections.filter(conn =>
                    conn.from.id !== nodeId && conn.to.id !== nodeId
                );
               
                // Remover elemento do DOM
                node.element.remove();
               
                // Remover do array
                this.nodes.splice(nodeIndex, 1);
               
                this.updateConnections();
                this.updateStats();
                this.updateAllDisconnectMenus();
                this.updateClearButtonEffect();
               
                if (this.selectedNode && this.selectedNode.id === nodeId) {
                    this.selectedNode = null;
                }
            }
           
            toggleConnectMode(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (!node) return;
               
                if (this.connectingMode && this.sourceNode) {
                    if (this.sourceNode.id === nodeId) {
                        this.connectingMode = false;
                        this.sourceNode = null;
                    } else {
                        this.createConnection(this.sourceNode, node);
                        this.connectingMode = false;
                        this.sourceNode = null;
                    }
                } else {
                    this.connectingMode = true;
                    this.sourceNode = node;
                }
            }
           
            createConnection(fromNode, toNode) {
                // Verificar se conex√£o j√° existe
                const exists = this.connections.some(conn =>
                    (conn.from.id === fromNode.id && conn.to.id === toNode.id) ||
                    (conn.from.id === toNode.id && conn.to.id === fromNode.id)
                );
               
                if (!exists) {
                    this.connections.push({ from: fromNode, to: toNode });
                    this.updateConnections();
                    this.updateStats();
                    this.updateAllDisconnectMenus();
                }
            }
            
            connectNodes(fromNodeId, toNodeId) {
                const fromNode = this.nodes.find(n => n.id === fromNodeId);
                const toNode = this.nodes.find(n => n.id === toNodeId);
                
                if (fromNode && toNode) {
                    this.createConnection(fromNode, toNode);
                }
            }
           
            updateNodePosition(node) {
                node.element.style.left = node.x + 'px';
                node.element.style.top = node.y + 'px';
            }
           
            updateConnections() {
                const svg = document.getElementById('connections');
                svg.innerHTML = '';
               
                if (this.connections.length === 0) return;
               
                // Calcular bounding box de todos os n√≥s conectados
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
               
                this.connections.forEach(conn => {
                    const fromRect = conn.from.element.getBoundingClientRect();
                    const toRect = conn.to.element.getBoundingClientRect();
                   
                    const fromX = conn.from.x;
                    const fromY = conn.from.y;
                    const toX = conn.to.x;
                    const toY = conn.to.y;
                   
                    // Expandir bounding box para incluir ambos os n√≥s
                    minX = Math.min(minX, fromX, toX);
                    minY = Math.min(minY, fromY, toY);
                    maxX = Math.max(maxX, fromX + fromRect.width, toX + toRect.width);
                    maxY = Math.max(maxY, fromY + fromRect.height, toY + toRect.height);
                });
               
                // Adicionar margem para as curvas das linhas
                const margin = 100;
                minX -= margin;
                minY -= margin;
                maxX += margin;
                maxY += margin;
               
                // Definir viewBox do SVG para cobrir toda a √°rea necess√°ria
                const width = maxX - minX;
                const height = maxY - minY;
                svg.setAttribute('viewBox', `${minX} ${minY} ${width} ${height}`);
                svg.style.position = 'absolute';
                svg.style.left = minX + 'px';
                svg.style.top = minY + 'px';
                svg.style.width = width + 'px';
                svg.style.height = height + 'px';
               
                // Desenhar as conex√µes
                this.connections.forEach(conn => {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                   
                    const fromRect = conn.from.element.getBoundingClientRect();
                    const toRect = conn.to.element.getBoundingClientRect();
                   
                    const fromX = conn.from.x + (fromRect.width / 2);
                    const fromY = conn.from.y + (fromRect.height / 2);
                    const toX = conn.to.x + (toRect.width / 2);
                    const toY = conn.to.y + (toRect.height / 2);
                   
                    // Criar curva suave
                    const midX = (fromX + toX) / 2;
                    const midY = (fromY + toY) / 2;
                    const controlOffset = Math.min(100, Math.abs(fromX - toX) * 0.3);
                   
                    const path = `M ${fromX} ${fromY} Q ${midX} ${midY - controlOffset} ${toX} ${toY}`;
                   
                    line.setAttribute('d', path);
                    line.setAttribute('class', 'connection-line');
                    svg.appendChild(line);
                });
            }
           
            updateStats() {
                document.getElementById('nodeCount').textContent = this.nodes.length;
                document.getElementById('connectionCount').textContent = this.connections.length;
                
                // Atualizar estat√≠sticas nas abas mobile
                const toolsStats = document.getElementById('toolsStats');
                const designStats = document.getElementById('designStats');
                const exportStats = document.getElementById('exportStats');
                const mobileNodeCount = document.getElementById('mobileNodeCount');
                const mobileConnectionCount = document.getElementById('mobileConnectionCount');
                
                if (toolsStats) toolsStats.textContent = this.nodes.length;
                if (designStats) designStats.textContent = this.connections.length;
                if (exportStats) exportStats.textContent = this.nodes.length + this.connections.length;
                if (mobileNodeCount) mobileNodeCount.textContent = this.nodes.length;
                if (mobileConnectionCount) mobileConnectionCount.textContent = this.connections.length;
            }

            updateNodeControls() {
                this.nodes.forEach(node => {
                    const disconnectBtn = node.element.querySelector('.control-btn.disconnect');
                    if (disconnectBtn) {
                        // Verificar se o n√≥ tem conex√µes
                        const hasConnections = this.connections.some(conn => 
                            conn.from.id === node.id || conn.to.id === node.id
                        );
                        disconnectBtn.style.display = hasConnections ? 'flex' : 'none';
                    }
                });
            }

            adjustNodeTextSize(node) {
                if (!node || !node.element) return;

                const content = node.element.querySelector('.node-content');
                if (!content) return;

                const nodeWidth = node.element.offsetWidth;
                const nodeHeight = node.element.offsetHeight;
                const text = content.textContent || content.innerText;
                
                // Calcular tamanho baseado na menor dimens√£o e comprimento do texto
                let baseSize;
                
                if (node.shape === 'circle') {
                    // Para c√≠rculo, usar o di√¢metro
                    const diameter = Math.min(nodeWidth, nodeHeight);
                    baseSize = Math.max(8, Math.min(24, diameter * 0.15));
                } else if (node.shape === 'square') {
                    // Para quadrado, usar o lado
                    const side = Math.min(nodeWidth, nodeHeight);
                    baseSize = Math.max(8, Math.min(24, side * 0.12));
                } else if (node.shape === 'ellipse') {
                    // Para elipse, usar a menor dimens√£o
                    const minDimension = Math.min(nodeWidth, nodeHeight);
                    baseSize = Math.max(8, Math.min(24, minDimension * 0.15));
                } else {
                    // Para ret√¢ngulo, usar a altura
                    baseSize = Math.max(8, Math.min(24, nodeHeight * 0.25));
                }

                // Ajustar baseado no comprimento do texto
                const textLength = text.length;
                if (textLength > 20) {
                    baseSize *= 0.8;
                } else if (textLength > 15) {
                    baseSize *= 0.9;
                } else if (textLength < 5) {
                    baseSize *= 1.1;
                }

                // Aplicar o tamanho da fonte
                content.style.fontSize = Math.round(baseSize) + 'px';
                
                // Ajustar line-height baseado no tamanho da fonte
                content.style.lineHeight = Math.round(baseSize * 1.2) + 'px';
                
                console.log(`Texto ajustado para n√≥ ${node.id}: ${Math.round(baseSize)}px (${nodeWidth}x${nodeHeight})`);
            }

            adjustAllNodesTextSize() {
                this.nodes.forEach(node => {
                    this.adjustNodeTextSize(node);
                });
            }
           
           
            updateZoom() {
                this.updateCanvasTransform();
                document.getElementById('zoomLevel').textContent = Math.round(this.zoomLevel * 100) + '%';
            }
            
            updateCanvasTransform() {
                const canvas = document.getElementById('canvas');
                canvas.style.transform = `translate(${this.panOffset.x}px, ${this.panOffset.y}px) scale(${this.zoomLevel})`;
                
                // Garantir que o canvas tenha tamanho adequado para as liga√ß√µes
                const canvasContainer = document.querySelector('.canvas-container');
                const containerRect = canvasContainer.getBoundingClientRect();
                
                // Calcular tamanho m√≠nimo baseado no zoom e no container
                const minWidth = Math.max(2000, containerRect.width * 2 / this.zoomLevel);
                const minHeight = Math.max(2000, containerRect.height * 2 / this.zoomLevel);
                
                canvas.style.minWidth = minWidth + 'px';
                canvas.style.minHeight = minHeight + 'px';
            }
           
           
            clearCanvas() {
                this.showClearConfirm();
            }

            // Mostrar confirma√ß√£o de limpeza
            showClearConfirm() {
                const clearConfirm = document.getElementById('clearConfirm');
                if (clearConfirm) {
                    clearConfirm.style.display = 'block';
                }
            }

            // Esconder confirma√ß√£o de limpeza
            hideClearConfirm() {
                const clearConfirm = document.getElementById('clearConfirm');
                if (clearConfirm) {
                    clearConfirm.style.display = 'none';
                }
            }

            // Executar limpeza ap√≥s confirma√ß√£o
            performClearCanvas() {
                this.nodes.forEach(node => node.element.remove());
                this.nodes = [];
                this.connections = [];
                this.selectedNode = null;
                this.nextNodeId = 1;
               
                document.getElementById('connections').innerHTML = '';
                this.updateStats();
                this.updateAllDisconnectMenus();
                this.updateClearButtonEffect();
               
                // Mostrar dica amig√°vel na primeira limpeza
                if (!this.hasClearedOnce) {
                    this.hasClearedOnce = true;
                    setTimeout(() => {
                        this.showFriendlyTip();
                    }, 500);
                }
               
                // Esconder confirma√ß√£o
                this.hideClearConfirm();
               
                // Canvas fica em branco - n√£o recria o mapa de exemplo
            }

            // Verificar se h√° n√≥s de exemplo presentes
            hasExampleNodes() {
                return this.nodes.some(node => node.isExample === true);
            }

            // Atualizar efeito do bot√£o Limpar baseado na presen√ßa de n√≥s de exemplo
            updateClearButtonEffect() {
                const clearButton = document.getElementById('clearButton');
                const clearButtonMobile = document.getElementById('clearButtonMobile');
                const hasExamples = this.hasExampleNodes();

                if (clearButton) {
                    if (hasExamples) {
                        clearButton.classList.add('example-present');
                    } else {
                        clearButton.classList.remove('example-present');
                    }
                }

                if (clearButtonMobile) {
                    if (hasExamples) {
                        clearButtonMobile.classList.add('example-present');
                    } else {
                        clearButtonMobile.classList.remove('example-present');
                    }
                }
            }

            // Mostrar dica amig√°vel
            showFriendlyTip() {
                const friendlyTip = document.getElementById('friendlyTip');
                if (friendlyTip) {
                    friendlyTip.style.display = 'block';
                }
            }

            // Esconder dica amig√°vel
            hideFriendlyTip() {
                const friendlyTip = document.getElementById('friendlyTip');
                if (friendlyTip) {
                    friendlyTip.style.display = 'none';
                }
            }
           
            setNodeColor(color) {
                this.currentColor = color;
               
                // Atualizar classe ativa (desktop)
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Atualizar classe ativa (mobile)
                document.querySelectorAll('.mobile-color-btn').forEach(el => el.classList.remove('active'));
                const mobileColorBtn = document.querySelector(`[data-color="${color}"]`);
                if (mobileColorBtn) {
                    mobileColorBtn.classList.add('active');
                }
               
                // Se h√° um n√≥ selecionado, alterar sua cor
                if (this.selectedNode) {
                    this.selectedNode.color = color;
                    this.selectedNode.element.style.backgroundColor = color;
                }
            }
            
            setNodeColorById(nodeId, color) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (node && node.element) {
                    node.color = color;
                    node.element.style.backgroundColor = color;
                }
            }

            setNodeShape(shape) {
                this.currentShape = shape;
               
                // Atualizar classe ativa (desktop)
                document.querySelectorAll('.shape-option').forEach(el => el.classList.remove('active'));
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                
                // Atualizar classe ativa (mobile)
                document.querySelectorAll('.mobile-shape-btn').forEach(el => el.classList.remove('active'));
                const mobileShapeBtn = document.querySelector(`[data-shape="${shape}"]`);
                if (mobileShapeBtn) {
                    mobileShapeBtn.classList.add('active');
                }
               
                // Se h√° um n√≥ selecionado, alterar seu formato
                if (this.selectedNode) {
                    this.selectedNode.shape = shape;
                    this.selectedNode.element.className = this.selectedNode.element.className.replace(/node-shape-\w+/, `node-shape-${shape}`);
                }
            }

            setCustomNodeColor(color) {
                this.customColor = color;
            }

            applyCustomColor() {
                this.currentColor = this.customColor;
                
                // Adicionar √† lista de cores recentes
                this.addToRecentColors(this.customColor);
                
                // Remover classe ativa de todas as op√ß√µes de cor
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                
                // Se h√° um n√≥ selecionado, alterar sua cor
                if (this.selectedNode) {
                    this.selectedNode.color = this.customColor;
                    this.selectedNode.element.style.backgroundColor = this.customColor;
                }
                
                // Mostrar feedback visual
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Aplicado!';
                button.style.background = 'linear-gradient(135deg, #2ed573, #1e90ff)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 1500);
            }

            addToRecentColors(color) {
                // Remover a cor se j√° existir
                this.recentColors = this.recentColors.filter(c => c !== color);
                
                // Adicionar no in√≠cio
                this.recentColors.unshift(color);
                
                // Manter apenas as 4 mais recentes
                this.recentColors = this.recentColors.slice(0, 4);
                
                // Atualizar a interface
                this.updateRecentColorsDisplay();
            }

            updateRecentColorsDisplay() {
                const grid = document.getElementById('recentColorsGrid');
                const mobileGrid = document.getElementById('mobileRecentColorsGrid');
                
                if (grid) {
                    grid.innerHTML = '';
                    
                    // Adicionar cores recentes
                    this.recentColors.forEach((color, index) => {
                        const colorOption = document.createElement('div');
                        colorOption.className = 'recent-color-option';
                        colorOption.style.backgroundColor = color;
                        colorOption.onclick = () => this.selectRecentColor(color);
                        colorOption.title = `Cor recente ${index + 1}: ${color}`;
                        grid.appendChild(colorOption);
                    });
                    
                    // Adicionar espa√ßos vazios se necess√°rio
                    const emptySlots = 4 - this.recentColors.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptyOption = document.createElement('div');
                        emptyOption.className = 'recent-color-option empty';
                        emptyOption.innerHTML = '?';
                        emptyOption.title = 'Nenhuma cor recente';
                        grid.appendChild(emptyOption);
                    }
                }
                
                if (mobileGrid) {
                    mobileGrid.innerHTML = '';
                    
                    // Adicionar cores recentes para mobile
                    this.recentColors.forEach((color, index) => {
                        const colorOption = document.createElement('button');
                        colorOption.className = 'mobile-color-btn';
                        colorOption.style.backgroundColor = color;
                        colorOption.onclick = () => this.selectRecentColor(color);
                        colorOption.title = `Cor recente ${index + 1}: ${color}`;
                        colorOption.setAttribute('data-color', color);
                        mobileGrid.appendChild(colorOption);
                    });
                    
                    // Adicionar espa√ßos vazios se necess√°rio
                    const emptySlots = 4 - this.recentColors.length;
                    for (let i = 0; i < emptySlots; i++) {
                        const emptyOption = document.createElement('div');
                        emptyOption.className = 'mobile-color-btn empty';
                        emptyOption.style.backgroundColor = '#f8f9fa';
                        emptyOption.style.border = '2px dashed #ccc';
                        emptyOption.innerHTML = '?';
                        emptyOption.title = 'Nenhuma cor recente';
                        emptyOption.style.cursor = 'default';
                        mobileGrid.appendChild(emptyOption);
                    }
                }
            }

            selectRecentColor(color) {
                this.currentColor = color;
                
                // Remover classe ativa de todas as op√ß√µes de cor (desktop)
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                
                // Remover classe ativa de todas as op√ß√µes de cor (mobile)
                document.querySelectorAll('.mobile-color-btn').forEach(el => el.classList.remove('active'));
                
                // Ativar cor selecionada (mobile)
                const mobileColorBtn = document.querySelector(`[data-color="${color}"]`);
                if (mobileColorBtn) {
                    mobileColorBtn.classList.add('active');
                }
                
                // Se h√° um n√≥ selecionado, alterar sua cor
                if (this.selectedNode) {
                    this.selectedNode.color = color;
                    this.selectedNode.element.style.backgroundColor = color;
                }
            }
           
            exportAsPNG() {
                try {
                    if (this.nodes.length === 0) {
                        alert('N√£o h√° n√≥s para exportar. Crie alguns n√≥s primeiro!');
                        return;
                    }

                    // Criar um canvas tempor√°rio para renderizar o mapa mental
                    const tempCanvas = document.createElement('canvas');
                    const ctx = tempCanvas.getContext('2d');
                    
                    // Calcular bounds de todos os n√≥s usando as posi√ß√µes reais
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    
                    this.nodes.forEach(node => {
                        const nodeX = node.x;
                        const nodeY = node.y;
                        const nodeWidth = node.element ? node.element.offsetWidth : 120;
                        const nodeHeight = node.element ? node.element.offsetHeight : 60;
                        
                        minX = Math.min(minX, nodeX);
                        minY = Math.min(minY, nodeY);
                        maxX = Math.max(maxX, nodeX + nodeWidth);
                        maxY = Math.max(maxY, nodeY + nodeHeight);
                    });
                    
                    // Adicionar margem generosa
                    const margin = 80;
                    const width = maxX - minX + (margin * 2);
                    const height = maxY - minY + (margin * 2);
                    
                    // Configurar canvas tempor√°rio com alta resolu√ß√£o
                    const scale = 2; // Para melhor qualidade
                    tempCanvas.width = width * scale;
                    tempCanvas.height = height * scale;
                    ctx.scale(scale, scale);
                    
                    // Configurar contexto para melhor qualidade
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Fundo branco
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    
                    // Desenhar conex√µes primeiro
                    this.connections.forEach(conn => {
                        const fromNode = conn.from;
                        const toNode = conn.to;
                        
                        const fromX = fromNode.x + (fromNode.element ? fromNode.element.offsetWidth / 2 : 60) - minX + margin;
                        const fromY = fromNode.y + (fromNode.element ? fromNode.element.offsetHeight / 2 : 30) - minY + margin;
                        const toX = toNode.x + (toNode.element ? toNode.element.offsetWidth / 2 : 60) - minX + margin;
                        const toY = toNode.y + (toNode.element ? toNode.element.offsetHeight / 2 : 30) - minY + margin;
                        
                        // Desenhar linha de conex√£o
                        ctx.strokeStyle = '#667eea';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        
                        // Criar curva suave
                        const midX = (fromX + toX) / 2;
                        const midY = (fromY + toY) / 2;
                        const controlOffset = Math.min(100, Math.abs(fromX - toX) * 0.3);
                        
                        ctx.moveTo(fromX, fromY);
                        ctx.quadraticCurveTo(midX, midY - controlOffset, toX, toY);
                        ctx.stroke();
                    });
                    
                    // Desenhar n√≥s
                    this.nodes.forEach(node => {
                        const x = node.x - minX + margin;
                        const y = node.y - minY + margin;
                        const nodeWidth = node.element ? node.element.offsetWidth : 120;
                        const nodeHeight = node.element ? node.element.offsetHeight : 60;
                        
                        // Desenhar fundo do n√≥
                        ctx.fillStyle = node.color;
                        ctx.strokeStyle = '#667eea';
                        ctx.lineWidth = 2;
                        
                        // Aplicar formato do n√≥
                        if (node.shape === 'rectangle') {
                            ctx.fillRect(x, y, nodeWidth, nodeHeight);
                            ctx.strokeRect(x, y, nodeWidth, nodeHeight);
                        } else if (node.shape === 'square') {
                            const size = Math.min(nodeWidth, nodeHeight);
                            ctx.fillRect(x, y, size, size);
                            ctx.strokeRect(x, y, size, size);
                        } else if (node.shape === 'circle') {
                            const radius = Math.min(nodeWidth, nodeHeight) / 2;
                            const centerX = x + nodeWidth / 2;
                            const centerY = y + nodeHeight / 2;
                            
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                            ctx.fill();
                            ctx.stroke();
                        } else if (node.shape === 'ellipse') {
                            const centerX = x + nodeWidth / 2;
                            const centerY = y + nodeHeight / 2;
                            
                            ctx.beginPath();
                            ctx.ellipse(centerX, centerY, nodeWidth / 2, nodeHeight / 2, 0, 0, 2 * Math.PI);
                            ctx.fill();
                            ctx.stroke();
                        }
                        
                        // Desenhar texto
                        ctx.fillStyle = '#000000';
                        ctx.font = 'bold 14px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        // Quebrar texto em m√∫ltiplas linhas se necess√°rio
                        const words = node.text.split(' ');
                        const lines = [];
                        let currentLine = words[0] || '';
                        
                        for (let i = 1; i < words.length; i++) {
                            const word = words[i];
                            const testLine = currentLine + ' ' + word;
                            const textWidth = ctx.measureText(testLine).width;
                            const maxWidth = nodeWidth * 0.8; // 80% da largura do n√≥
                            
                            if (textWidth < maxWidth) {
                                currentLine = testLine;
                            } else {
                                lines.push(currentLine);
                                currentLine = word;
                            }
                        }
                        if (currentLine) lines.push(currentLine);
                        
                        // Desenhar linhas de texto centralizadas
                        const lineHeight = 18;
                        const totalTextHeight = lines.length * lineHeight;
                        const startY = y + nodeHeight / 2 - totalTextHeight / 2 + lineHeight / 2;
                        
                        lines.forEach((line, index) => {
                            const textX = x + nodeWidth / 2;
                            const textY = startY + index * lineHeight;
                            ctx.fillText(line, textX, textY);
                        });
                    });
                    
                    // Converter para blob e fazer download
                    tempCanvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'mapa-mental.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        // Mostrar mensagem de sucesso
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #4CAF50;
                            color: white;
                            padding: 15px 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                            z-index: 10000;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        `;
                        successMsg.textContent = '‚úÖ Mapa mental exportado como PNG!';
                        document.body.appendChild(successMsg);
                        
                        setTimeout(() => {
                            document.body.removeChild(successMsg);
                        }, 3000);
                    }, 'image/png', 1.0);
                    
                } catch (error) {
                    console.error('Erro ao exportar PNG:', error);
                    alert('Erro ao exportar PNG. Tente novamente.');
                }
            }
           
            exportAsJSON() {
                const data = {
                    nodes: this.nodes.map(node => ({
                        id: node.id,
                        x: node.x,
                        y: node.y,
                        text: node.text,
                        color: node.color,
                        shape: node.shape,
                        mediaData: node.mediaData
                    })),
                    connections: this.connections.map(conn => ({
                        from: conn.from.id,
                        to: conn.to.id
                    })),
                    nextNodeId: this.nextNodeId
                };
               
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mapa-mental.json';
                a.click();
                URL.revokeObjectURL(url);
            }
           
            importJSON() {
                document.getElementById('fileInput').click();
            }
           
            loadFromJSON(data) {
                // Limpar canvas atual
                this.nodes.forEach(node => node.element.remove());
                this.nodes = [];
                this.connections = [];
                this.selectedNode = null;
                document.getElementById('connections').innerHTML = '';
               
                // Carregar n√≥s
                data.nodes.forEach(nodeData => {
                    const node = {
                        id: nodeData.id,
                        x: nodeData.x,
                        y: nodeData.y,
                        text: nodeData.text,
                        color: nodeData.color || '#ffffff',
                        shape: nodeData.shape || 'rectangle',
                        mediaData: nodeData.mediaData || null,
                        element: null
                    };
                    this.nodes.push(node);
                    this.createNodeElement(node);
                });
               
                // Carregar conex√µes
                data.connections.forEach(connData => {
                    const fromNode = this.nodes.find(n => n.id === connData.from);
                    const toNode = this.nodes.find(n => n.id === connData.to);
                    if (fromNode && toNode) {
                        this.connections.push({ from: fromNode, to: toNode });
                    }
                });
               
                this.nextNodeId = data.nextNodeId || this.nodes.length + 1;
               
                this.updateConnections();
                this.updateStats();
                this.updateAllDisconnectMenus();
                
                // Ajustar tamanho do texto para todos os n√≥s carregados
                setTimeout(() => {
                    this.nodes.forEach(node => {
                        this.adjustNodeTextSize(node);
                    });
                }, 200);
            }
           
            zoomIn() {
                const oldZoom = this.zoomLevel;
                this.zoomLevel *= 1.2;
                this.zoomLevel = Math.min(3, this.zoomLevel);
                
                // Ajustar pan offset para zoom no ponto do mouse
                const zoomRatio = this.zoomLevel / oldZoom;
                this.panOffset.x = this.mousePosition.x - (this.mousePosition.x - this.panOffset.x) * zoomRatio;
                this.panOffset.y = this.mousePosition.y - (this.mousePosition.y - this.panOffset.y) * zoomRatio;
                
                this.updateZoom();
            }
           
            zoomOut() {
                const oldZoom = this.zoomLevel;
                this.zoomLevel *= 0.8;
                this.zoomLevel = Math.max(0.1, this.zoomLevel);
                
                // Ajustar pan offset para zoom no ponto do mouse
                const zoomRatio = this.zoomLevel / oldZoom;
                this.panOffset.x = this.mousePosition.x - (this.mousePosition.x - this.panOffset.x) * zoomRatio;
                this.panOffset.y = this.mousePosition.y - (this.mousePosition.y - this.panOffset.y) * zoomRatio;
                
                this.updateZoom();
            }
            
            resetZoom() {
                this.zoomLevel = 1;
                this.panOffset = { x: 200, y: 435 };
                this.updateZoom();
            }
           

            changeTheme(themeName) {
                // Remover todas as classes de tema do body
                document.body.classList.remove('theme-blue', 'theme-green', 'theme-white');
                
                // Adicionar a nova classe de tema
                if (themeName !== 'default') {
                    document.body.classList.add(`theme-${themeName}`);
                }
                
                // Atualizar tema ativo nos bot√µes (desktop)
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                });
                const desktopThemeBtn = document.querySelector(`[data-theme="${themeName}"]`);
                if (desktopThemeBtn) {
                    desktopThemeBtn.classList.add('active');
                }
                
                // Atualizar tema ativo nos bot√µes (mobile)
                document.querySelectorAll('.mobile-theme-btn').forEach(option => {
                    option.classList.remove('active');
                });
                const mobileThemeBtn = document.querySelector(`.mobile-theme-btn[data-theme="${themeName}"]`);
                if (mobileThemeBtn) {
                    mobileThemeBtn.classList.add('active');
                }
                
                // Salvar tema atual
                this.currentTheme = themeName;
                
                // Atualizar conex√µes com nova cor
                this.updateConnections();
                
                // Salvar tema no localStorage
                localStorage.setItem('mindmap-theme', themeName);
                
                console.log('Tema alterado para:', themeName);
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('mindmap-theme') || 'default';
                this.changeTheme(savedTheme);
            }

            toggleControlsExpansion(nodeId) {
                const expanded = document.getElementById(`controls-expanded-${nodeId}`);
                if (!expanded) return;

                // Fechar outros controles expandidos
                if (this.activeControlsMenu && this.activeControlsMenu !== expanded) {
                    this.activeControlsMenu.classList.remove('show');
                }

                // Toggle dos controles atuais
                if (expanded.classList.contains('show')) {
                    expanded.classList.remove('show');
                    this.controlsMenuVisible = false;
                    this.activeControlsMenu = null;
                } else {
                    expanded.classList.add('show');
                    this.controlsMenuVisible = true;
                    this.activeControlsMenu = expanded;
                }
            }

            hideControlsMenu() {
                if (this.activeControlsMenu) {
                    this.activeControlsMenu.classList.remove('show');
                    this.controlsMenuVisible = false;
                    this.activeControlsMenu = null;
                }
            }
        }
       
        // Inicializar aplica√ß√£o
        const app = new MindMapApp();


        // ========================================
        // Desenvolvido por: Morphyro
        // Organiza√ß√£o: S(i)S - Surrealist Inner Society
        // Aplica√ß√£o: Mapa Mental Interativo
        // Vers√£o: 1.0
        // ========================================
       
        // Fun√ß√µes globais para os bot√µes
        function addNode() {
            app.addNode();
        }
       
        function clearCanvas() {
            app.clearCanvas();
        }

        function hideFriendlyTip() {
            app.hideFriendlyTip();
        }

        function hideClearConfirm() {
            app.hideClearConfirm();
        }

        function confirmClearCanvas() {
            app.performClearCanvas();
        }
        
        function adjustAllTextSizes() {
            app.adjustAllNodesTextSize();
        }
       
       
        function setNodeColor(color) {
            app.setNodeColor(color);
        }

        function setNodeShape(shape) {
            app.setNodeShape(shape);
        }

        function setCustomNodeColor(color) {
            app.setCustomNodeColor(color);
        }

        function applyCustomColor() {
            app.applyCustomColor();
        }
       
        function exportAsPNG() {
            app.exportAsPNG();
        }
       
        function exportAsJSON() {
            app.exportAsJSON();
        }
       
        function importJSON() {
            app.importJSON();
        }
       
        function zoomIn() {
            app.zoomIn();
        }
       
        function zoomOut() {
            app.zoomOut();
        }
       
        
        function resetZoom() {
            app.resetZoom();
        }

        function changeTheme(themeName) {
            app.changeTheme(themeName);
        }

        // Fun√ß√µes para controle das abas mobile
        function switchMobileTab(tabName) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.mobile-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os pain√©is
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Ativar aba selecionada
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Ativar painel correspondente
            const selectedPanel = document.getElementById(`${tabName}-panel`);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
            }
            
            // Feedback t√°til para mobile
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }

        // Fun√ß√£o para controlar retra√ß√£o/expans√£o da mobile toolkit
        function toggleMobileToolkit() {
            app.toggleMobileToolkit();
        }
       
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        app.loadFromJSON(data);
                    } catch (error) {
                        alert('Erro ao carregar arquivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
       
        // Atalhos de teclado globais
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        addNode();
                        break;
                    case 's':
                        e.preventDefault();
                        exportAsJSON();
                        break;
                    case 'o':
                        e.preventDefault();
                        importJSON();
                        break;
                    case '=':
                    case '+':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        e.preventDefault();
                        resetZoom();
                        break;
                }
            }
        });
       
        // Melhorias na experi√™ncia do usu√°rio
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar tooltips para atalhos
            const tooltips = {
                'Ctrl+N': 'Novo n√≥',
                'Ctrl+S': 'Salvar projeto',
                'Ctrl+O': 'Abrir projeto',
                'Ctrl++': 'Zoom in',
                'Ctrl+-': 'Zoom out',
                'Ctrl+0': 'Reset zoom',
                'Ctrl+V': 'Colar imagem/v√≠deo',
                'Shift+Click': 'Adicionar n√≥',
                'Click direito': 'Menu de formas para novo n√≥',
                'Duplo-click': 'Editar n√≥',
                'Delete': 'Deletar n√≥ selecionado',
                'Enter': 'Editar n√≥ selecionado',
                'Esc': 'Cancelar a√ß√£o',
                'Arrastar canvas': 'Pan/mover vis√£o',
                'Arrastar n√≥': 'Mover n√≥',
                'Bot√£o üìè': 'Redimensionar n√≥',
                'Seletor de cor': 'Criar cor personalizada',
                'Cores recentes': 'Selecionar cores anteriores',
                'Scroll mouse': 'Zoom in/out'
            };
           
            // Adicionar informa√ß√µes de ajuda
            // const helpBtn = document.createElement('button');
            // helpBtn.className = 'btn btn-secondary';
            // helpBtn.innerHTML = '‚ùì Ajuda';
            // helpBtn.onclick = function() {
            //     const helpText = Object.entries(tooltips)
            //         .map(([key, desc]) => `${key}: ${desc}`)
            //         .join('\n');
            //     alert('Atalhos de Teclado:\n\n' + helpText + '\n\nDicas:\n‚Ä¢ Arraste n√≥s para mov√™-los com anima√ß√µes suaves\n‚Ä¢ Arraste o canvas vazio para fazer pan/mover a vis√£o\n‚Ä¢ Use Shift+Click para adicionar n√≥s rapidamente\n‚Ä¢ Clique com bot√£o direito para escolher formato do n√≥\n‚Ä¢ Clique em "Conectar" para ligar n√≥s\n‚Ä¢ Clique em "üìè" para redimensionar n√≥s\n‚Ä¢ Use o seletor de cor personalizada para criar cores √∫nicas\n‚Ä¢ Acesse cores recentes para reutilizar cores anteriores\n‚Ä¢ Use o scroll do mouse para zoom (zoom no ponto do mouse)\n‚Ä¢ Cole imagens e v√≠deos com Ctrl+V\n‚Ä¢ Escolha diferentes formatos de n√≥s na sidebar ou menu de contexto\n‚Ä¢ Use a sidebar com scroll para navegar\n‚Ä¢ Suporte completo para touch em dispositivos m√≥veis');
            // };
           
            // Adicionar bot√£o de ajuda √† toolbar
            const toolbar = document.querySelector('.toolbar');
            toolbar.appendChild(helpBtn);
        });
    </script>
</body>
</html>
